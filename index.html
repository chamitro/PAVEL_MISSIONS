<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
    <title>Missions in Pavel</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=MedievalSharp&family=Almendra:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        :root { 
            --gold: #c5a059; --gold-bright: #8b0000; --iron: #2c2c2c;
            --parchment: #d4c3a3; --blood: #800000; --ink: #1a0f08;
            --shadow: rgba(0,0,0,0.8);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin:0; font-family: 'Almendra', serif; 
            background: radial-gradient(ellipse at center, #1a1520 0%, #0d0a15 50%, #000000 100%);
            color: #d1d1d1;
            min-height: 100vh; overflow-x: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(139, 0, 0, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(197, 160, 89, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(90, 58, 26, 0.08) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }
        
        /* Animated green aura moving in background - OPTIMIZED */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 30% 40%, rgba(46, 255, 87, 0.15) 0%, transparent 30%),
                radial-gradient(circle at 70% 60%, rgba(76, 255, 120, 0.12) 0%, transparent 35%);
            pointer-events: none;
            z-index: 0;
            animation: auraFloat 15s ease-in-out infinite;
            will-change: opacity;
        }
        
        @keyframes auraFloat {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        .container {
            position: relative;
            z-index: 1;
        }
        h1, h2, h3, .medieval { font-family: 'Cinzel Decorative', serif; color: var(--gold); text-shadow: 2px 2px 4px #000; }
        .container { max-width: 480px; margin: 0 auto; padding: 15px; position: relative; animation: fadeIn 0.4s ease-in-out; }
        .progress-map { width: 100%; height: 14px; background: #111; border: 2px solid #444; border-radius: 10px; margin-bottom: 25px; overflow: hidden; box-shadow: inset 0 2px 5px #000; }
        .progress-marker { 
            height: 100%; 
            background: linear-gradient(90deg, #400, var(--gold), #fff, var(--gold), #400);
            background-size: 200% 100%;
            width: 0%; 
            transition: 1s cubic-bezier(0.4, 0, 0.2, 1);
            animation: shimmer 3s linear infinite;
            box-shadow: 0 0 10px rgba(197, 160, 89, 0.6);
        }
        .stage-frame {
            background-color: #1a1a1a; background-image: url('https://www.transparenttextures.com/patterns/stardust.png');
            border: 8px solid #333; border-radius: 2px; padding: 30px 20px; text-align: center; margin-bottom: 20px; box-shadow: 0 10px 30px #000;
            animation: dealCard 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .st-title { 
            font-size: 24px; 
            text-transform: uppercase; 
            margin: 10px 0; 
            color: var(--gold-bright);
            animation: glow 3s ease-in-out infinite;
        }
        .st-desc { font-family: 'MedievalSharp', cursive; color: #aaa; font-size: 16px; line-height: 1.4; }
        .hero-sheet {
            background: var(--parchment); color: var(--ink); border-radius: 2px; padding: 15px; margin-bottom: 15px;
            border: 1px solid #8e7b55; box-shadow: 5px 5px 15px rgba(0,0,0,0.5); position: relative;
            background-image: url('https://www.transparenttextures.com/patterns/parchment.png'); transition: 0.3s;
        }
        .hero-sheet.active-now { 
            transform: scale(1.02); 
            border: 2px solid var(--gold); 
            box-shadow: 0 0 20px rgba(197, 160, 89, 0.6), 0 0 40px rgba(139, 0, 0, 0.4); 
            animation: magic-pulse 2s infinite ease-in-out;
            position: relative;
            z-index: 10;
            will-change: opacity;
        }
        /* NEW: Reader indicator */
        .hero-sheet.is-reader {
            border: 2px solid #9370DB;
            box-shadow: 0 0 15px rgba(147, 112, 219, 0.5);
        }
        .hero-sheet.is-reader::before {
            content: 'ðŸ“œ READER';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: #9370DB;
            color: #fff;
            padding: 2px 12px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            font-family: 'Cinzel Decorative';
            letter-spacing: 1px;
        }
        .wax-seal {
            position: absolute; top: -10px; right: -5px; width: 45px; height: 45px;
            background: radial-gradient(#900, #500); border-radius: 50%; color: #f3cf7a;
            display: flex; align-items: center; justify-content: center; font-weight: 900;
            font-family: 'Cinzel Decorative'; border: 2px solid #400; box-shadow: 2px 2px 8px #000; font-size: 18px; transform: rotate(5deg);
            transition: transform 0.6s ease;
        }
        .wax-seal:hover {
            transform: rotate(360deg) scale(1.1);
        }
        .meditate-count { 
            position: absolute; 
            top: 5px; 
            right: 60px; 
            font-size: 6px; 
            font-weight: bold; 
            color: #fce4ec;
            font-family: 'Cinzel Decorative';
            background: linear-gradient(135deg, #9fb3c8 0%, #b6c7d6 100%);
            border: 1px solid #c7d4df;
            box-shadow: 0 1px 4px rgba(159, 179, 200, 0.35),
            inset 0 1px 0 rgba(255,255,255,0.4);
            padding: 2px 6px;
            border-radius: 15px;
            letter-spacing: 0.5px;
            z-index: 5;
        }
        .stat-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-top: 15px; }
        .stat-box { background: rgba(0,0,0,0.05); padding: 8px 2px; text-align: center; border: 1px solid rgba(0,0,0,0.1); border-radius: 3px; }
        .stat-val { display: block; font-family: 'Cinzel Decorative'; font-weight: 900; font-size: 18px; color: #400; }
        .stat-lbl { font-size: 8px; font-weight: 900; text-transform: uppercase; color: #5a4634; }
        .btn { border-radius: 0; padding: 16px; border: 2px solid var(--gold); font-weight: 900; font-size: 14px; cursor: pointer; width: 100%; transition: 0.3s; margin-bottom: 10px; text-transform: uppercase; font-family: 'Cinzel Decorative'; letter-spacing: 1px; }
        .btn-main { 
            background: linear-gradient(90deg, #1a1a1a 0%, #2a2a2a 50%, #1a1a1a 100%);
            background-size: 200% 100%;
            color: var(--gold); 
            box-shadow: 0 4px 0 #000;
            animation: shimmer 6s ease-in-out infinite;
            position: relative;
            overflow: hidden;
        }
        .btn-main::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(197, 160, 89, 0.2), transparent);
            animation: shine 3s infinite;
        }
        .btn-fight { background: #2b1010; color: #9f9; border-color: #8b0000; }
        .btn-skip { background: #222; color: #888; border-color: #444; }
        .btn-danger { background: #400; color: #fcc; border-color: #700; }
        .overlay { 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.95); 
            display: none; 
            align-items: center; 
            justify-content: center; 
            z-index: 1000; 
            padding: 20px; 
            animation: fadeIn 0.3s ease;
        }
        .modal { 
            background: var(--parchment); 
            color: var(--ink); 
            border: 10px solid #2c2c2c; 
            padding: 30px; 
            width: 100%; 
            max-width: 400px; 
            max-height: 90vh;
            overflow-y: auto;
            background-image: url('https://www.transparenttextures.com/patterns/parchment.png'); 
            box-shadow: 0 0 50px #000; 
            text-align: center;
            animation: float 0.5s ease-out;
        }
        .input-hero { background: rgba(0,0,0,0.05); border: none; border-bottom: 2px solid #5a4634; color: var(--ink); font-family: 'MedievalSharp'; padding: 10px; }
        .instruction-text { text-align: left; font-size: 14px; line-height: 1.4; color: var(--ink); margin-bottom: 15px; }
        .instruction-text b { color: var(--blood); }
        
        /* Subtle Professional Animations */
        @keyframes glow {
            0%, 100% { text-shadow: 0 0 10px var(--gold), 0 0 20px var(--gold), 2px 2px 4px #000; }
            50% { text-shadow: 0 0 20px var(--gold-bright), 0 0 30px var(--gold-bright), 2px 2px 4px #000; }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }
        
        @keyframes slideInLeft {
            from { transform: translateX(-50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }
        
        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        @keyframes diceRoll {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(90deg) scale(1.2); }
            50% { transform: rotate(180deg) scale(1); }
            75% { transform: rotate(270deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1); }
        }
        @keyframes magic-pulse {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(197, 160, 89, 0.6), 0 0 40px rgba(139, 0, 0, 0.4);
                opacity: 1;
            }
            50% { 
                box-shadow: 0 0 20px rgba(197, 160, 89, 0.6), 0 0 40px rgba(139, 0, 0, 0.4);
                opacity: 0.85;
            }
        }

        @keyframes dealCard {
            from {
                transform: translateY(-100px) rotate(-5deg);
                opacity: 0;
            }
            to {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
        }

        @keyframes ping {
            0% {
                box-shadow: 0 0 0 0 rgba(197, 160, 89, 0.7);
            }
            70% {
                box-shadow: 0 0 0 20px rgba(197, 160, 89, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(197, 160, 89, 0);
            }
        }
        
        .dice {
            display: inline-block;
            width: 100px;
            height: 100px;
            background: linear-gradient(145deg, #ffffff, #e8e8e8);
            border-radius: 15px;
            position: relative;
            box-shadow: 
                0 10px 30px rgba(0,0,0,0.4),
                inset 0 3px 6px rgba(255,255,255,0.9),
                inset 0 -3px 6px rgba(0,0,0,0.1);
            animation: diceRoll 0.6s ease-in-out;
            filter: drop-shadow(0 0 15px rgba(197, 160, 89, 0.7));
            border: 3px solid #d4d4d4;
        }
        
        .dice::before {
            content: '';
            position: absolute;
            inset: 8px;
            background: linear-gradient(145deg, #fafafa, #f0f0f0);
            border-radius: 10px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .dice-dot {
            position: absolute;
            width: 16px;
            height: 16px;
            background: radial-gradient(circle, #1a1a1a, #000);
            border-radius: 50%;
            box-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.5),
                inset 0 1px 2px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }
        
        /* Subtle button hover effects */
        .btn {
            transition: all 0.2s ease;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 0 #000;
        }
        
        .btn:active {
            transform: translateY(1px);
            box-shadow: 0 3px 0 #000;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* Hero sheet subtle enhancements */
        .hero-sheet {
            transition: all 0.3s ease;
        }
        
        .hero-sheet:hover {
            transform: translateY(-2px);
            box-shadow: 5px 8px 20px rgba(0,0,0,0.6);
        }
        
        /* Stat box subtle animations */
        .stat-box {
            transition: all 0.2s ease;
        }
        
        .stat-box:hover {
            transform: scale(1.05);
            background: rgba(197, 160, 89, 0.1);
        }
        
        /* Active hero stat boxes glow */
        .active-now .stat-box {
            background: rgba(197, 160, 89, 0.15);
            border-color: var(--gold);
            box-shadow: 0 0 5px rgba(197, 160, 89, 0.3);
        }

        .active-now .stat-val {
            color: var(--gold-bright);
            text-shadow: 0 0 8px rgba(139, 0, 0, 0.5);
        }
        
        /* Progress bar subtle animation */
        .progress-marker {
            height: 100%;
            background: linear-gradient(90deg, #400, var(--gold), #400);
            background-size: 200% 100%;
            width: 0%;
            transition: 1s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .progress-marker::after {
            content: 'ðŸ”¥';
            position: absolute;
            right: -10px;
            top: -5px;
            font-size: 14px;
            text-shadow: 0 0 10px orange;
            animation: float 2s infinite ease-in-out;
        }
        
        .result-success {
            color: #2ecc71;
            font-weight: bold;
            animation: float 1s ease-in-out;
            text-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
        }

        .result-failure {
            color: #e74c3c;
            font-weight: bold;
            animation: pulse 0.5s ease-in-out;
            text-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
        }
        
        .turn-banner {
            background: linear-gradient(90deg, transparent, var(--gold-bright), transparent);
            color: #fff;
            text-align: center;
            padding: 8px;
            font-family: 'Cinzel Decorative';
            font-size: 14px;
            letter-spacing: 3px;
            text-shadow: 2px 2px 4px #000;
            margin-bottom: 15px;
            animation: glow 2s infinite;
            box-shadow: 0 0 20px rgba(139, 0, 0, 0.6);
        }
        
        /* Reader banner */
        .reader-banner {
            background: linear-gradient(90deg, transparent, #9370DB, transparent);
            color: #fff;
            text-align: center;
            padding: 6px;
            font-family: 'Cinzel Decorative';
            font-size: 12px;
            letter-spacing: 2px;
            text-shadow: 2px 2px 4px #000;
            margin-bottom: 10px;
        }
        
        .affinity-bonus-active {
            position: relative;
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.2), rgba(39, 174, 96, 0.3));
            border: 2px solid #2ecc71 !important;
            box-shadow: 0 0 20px rgba(46, 204, 113, 0.4);
        }

        .affinity-bonus-active::after {
            content: "âš¡ AFFINITY BONUS +3";
            position: absolute;
            top: -12px;
            right: 10px;
            background: #2ecc71;
            color: #fff;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 9px;
            font-weight: bold;
            font-family: 'Cinzel Decorative';
            letter-spacing: 1px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .score-display {
            font-family: 'Cinzel Decorative';
            font-size: 20px;
            color: var(--gold);
            text-shadow: 0 0 10px rgba(197, 160, 89, 0.5);
            animation: pulse 2s infinite;
        }

        /* Fullscreen splash screen */
        #fullscreen-splash {
            position: fixed;
            inset: 0;
            background: #0a0a0a;
            background-image: radial-gradient(circle at 50% 50%, rgba(0,0,0,0.4) 0%, #000 100%), url('https://www.transparenttextures.com/patterns/dark-stone.png');
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            flex-direction: column;
            gap: 30px;
        }
        
        #fullscreen-splash h1 {
            font-family: 'Cinzel Decorative', serif;
            color: #f3cf7a;
            font-size: 32px;
            text-align: center;
            margin: 0;
            text-shadow: 2px 2px 4px #000;
        }
        
        #fullscreen-splash p {
            font-family: 'Almendra', serif;
            color: #d4c3a3;
            font-size: 16px;
            text-align: center;
            margin: 0;
            max-width: 400px;
            padding: 0 20px;
        }
        
        #enter-fullscreen-btn {
            background: linear-gradient(135deg, #4a3520 0%, #6b5030 50%, #4a3520 100%);
            border: 3px solid var(--gold);
            border-radius: 5px;
            padding: 20px 40px;
            color: #f3cf7a;
            font-family: 'Cinzel Decorative', serif;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        #enter-fullscreen-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(197,160,89,0.4);
            background: linear-gradient(135deg, #5a4530 0%, #7b6040 50%, #5a4530 100%);
        }
        
        #exit-fullscreen {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 10000;
            background: rgba(0,0,0,0.7);
            border: 2px solid var(--gold);
            border-radius: 5px;
            padding: 8px 12px;
            color: var(--gold);
            font-family: 'MedievalSharp', cursive;
            font-size: 11px;
            cursor: pointer;
            display: none;
        }
        
        @media (max-width: 768px) {
            #exit-fullscreen {
                display: block;
            }
        }
        
        /* ========== RESPONSIVE BOOK CLASSES ========== */
        
        /* Book container */
        .book-container {
            margin-top: 20px;
            padding: 15px;
            overflow-y: auto;
            max-height: 85vh;
        }
        
        .book-title {
            color: var(--blood);
            text-align: center;
            margin: 0 0 5px 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .book-subtitle {
            text-align: center;
            font-style: italic;
            color: #5a4634;
            margin: 0 0 15px 0;
        }
        
        .book-divider {
            border: none;
            border-top: 1px solid #a08060;
            margin: 15px 0;
        }
        
        /* Map container - always full width */
        .map-container {
            width: 100%;
            border: 3px solid #8b7355;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .map-container img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        /* Hero cards - MOBILE FIRST (stacked layout with big image) */
        .hero-card {
            background: linear-gradient(135deg, #f8f4ec 0%, #ebe3d3 100%);
            border: 1px solid #c9b896;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .hero-card-top {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .hero-card-img {
            width: 80px;
            height: 80px;
            border: 3px solid #8b7355;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }
        
        .hero-card-info {
            flex: 1;
            min-width: 0;
        }
        
        .hero-card-name {
            font-size: 16px;
            font-weight: bold;
            color: #2a2a2a;
            margin: 0 0 4px 0;
        }
        
        .hero-card-stats {
            display: inline-block;
            font-size: 12px;
            color: #555;
            background: #fff;
            padding: 3px 10px;
            border-radius: 12px;
            border: 1px solid #ddd;
        }
        
        .hero-card-desc {
            font-size: 13px;
            color: #555;
            margin: 0 0 8px 0;
            line-height: 1.4;
        }
        
        .hero-card-ability {
            font-size: 13px;
            color: #333;
            margin: 0;
            padding: 8px 10px;
            background: rgba(139, 0, 0, 0.08);
            border-left: 3px solid var(--blood);
            border-radius: 0 6px 6px 0;
            line-height: 1.4;
        }
        
        .hero-card-ability b {
            color: var(--blood);
        }
        
        /* Location cards */
        .location-card {
            background: linear-gradient(135deg, #f8f4ec 0%, #ebe3d3 100%);
            padding: 12px 15px;
            border-left: 4px solid var(--blood);
            margin: 12px 0;
            border-radius: 0 8px 8px 0;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }
        
        .location-card-title {
            margin: 0 0 6px 0;
            color: var(--blood);
            font-size: 14px;
            font-weight: bold;
        }
        
        .location-card-text {
            margin: 0;
            font-size: 13px;
            color: #444;
            line-height: 1.5;
        }
        
        /* Book text */
        .book-text {
            font-size: 14px;
            color: #3a3a3a;
            line-height: 1.6;
            text-align: justify;
        }
        
        .book-text p {
            margin: 0 0 12px 0;
        }
        
        .book-text b {
            color: var(--blood);
        }
        
        /* ========== DESKTOP STYLES (min-width: 500px) ========== */
        @media (min-width: 500px) {
            .book-container {
                padding: 25px;
            }
            
            .book-title {
                font-size: 28px;
            }
            
            .book-subtitle {
                font-size: 13px;
            }
            
            .hero-card {
                padding: 18px;
            }
            
            .hero-card-img {
                width: 100px;
                height: 100px;
            }
            
            .hero-card-name {
                font-size: 18px;
            }
            
            .hero-card-stats {
                font-size: 13px;
            }
            
            .hero-card-desc {
                font-size: 14px;
            }
            
            .hero-card-ability {
                font-size: 14px;
            }
            
            .location-card {
                padding: 15px 18px;
            }
            
            .location-card-title {
                font-size: 16px;
            }
            
            .location-card-text {
                font-size: 14px;
            }
            
            .book-text {
                font-size: 15px;
            }
        }
        
        /* ========== MOBILE GAME UI STYLES ========== */
        @media (max-width: 600px) {
            .container {
                max-width: 100%;
                padding: 10px;
            }
            
            .stage-frame {
                padding: 20px 15px;
                border-width: 5px;
            }
            
            .st-title {
                font-size: 18px;
            }
            
            .st-desc {
                font-size: 14px;
            }
            
            .hero-sheet {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            .btn {
                padding: 12px;
                font-size: 12px;
            }
            
            .modal {
                padding: 20px;
                max-width: 95%;
                border-width: 6px;
            }
            
            .stat-grid {
                gap: 4px;
            }
            
            .stat-box {
                padding: 6px 2px;
            }
            
            .stat-val {
                font-size: 14px;
            }
            
            .stat-lbl {
                font-size: 7px;
            }
            
            .wax-seal {
                width: 38px;
                height: 38px;
                font-size: 14px;
            }
            
            .meditate-count {
                font-size: 8px;
                right: 50px;
            }
            
            /* Scroll buttons */
            .scroll-btn {
                height: 100px !important;
            }
            
            .scroll-btn h3 {
                font-size: 16px !important;
            }
            
            .scroll-btn p {
                font-size: 11px !important;
            }
            
            /* Splash screen */
            #fullscreen-splash img {
                width: 200px !important;
            }
            
            #fullscreen-splash h1 {
                font-size: 24px !important;
            }
            
            #fullscreen-splash p {
                font-size: 14px !important;
            }
            
            /* Game screen hero images */
            .hero-sheet img:not(.hero-card-img) {
                width: 50px !important;
                height: 50px !important;
            }
            
            .hero-sheet .medieval {
                font-size: 16px !important;
            }
            
            .turn-banner, .reader-banner {
                font-size: 11px !important;
                padding: 5px !important;
            }
        }
        
        /* ========== SMALL PHONES ========== */
        @media (max-width: 400px) {
            .container {
                padding: 8px;
            }
            
            .book-container {
                padding: 12px;
            }
            
            .book-title {
                font-size: 20px;
            }
            
            .hero-card {
                padding: 12px;
            }
            
            .hero-card-top {
                gap: 12px;
            }
            
            .hero-card-img {
                width: 70px;
                height: 70px;
            }
            
            .hero-card-name {
                font-size: 15px;
            }
            
            .hero-card-stats {
                font-size: 11px;
            }
            
            .hero-card-desc {
                font-size: 12px;
            }
            
            .hero-card-ability {
                font-size: 12px;
                padding: 6px 8px;
            }
            
            .stage-frame {
                padding: 15px 10px;
                border-width: 4px;
            }
            
            .st-title {
                font-size: 16px;
            }
            
            .btn {
                padding: 10px;
                font-size: 11px;
            }
            
            .stat-val {
                font-size: 12px;
            }
            
            .stat-lbl {
                font-size: 6px;
            }
            
            .wax-seal {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }
            
            .scroll-btn {
                height: 85px !important;
            }
            
            .scroll-btn h3 {
                font-size: 14px !important;
            }
            
            .dice {
                width: 70px !important;
                height: 70px !important;
            }
            
            .dice-dot {
                width: 12px !important;
                height: 12px !important;
            }
        }
        
        /* Desktop container max-width */
        @media (min-width: 601px) {
            .container {
                max-width: 480px;
            }
        }
    </style>
</head>
<body>

<!-- Fullscreen splash screen -->
<div id="fullscreen-splash">
    <img src="./images/map.png" alt="Pavel Map" style="max-width: 280px; width: 80%; height: auto; margin-bottom: 20px; border: 3px solid var(--gold); border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.5);">
    <h1>Missions in Pavel</h1>
    <p>For the best experience, this game is designed to be played in fullscreen mode.</p>
    <button id="enter-fullscreen-btn" onclick="startGameFullscreen()">Enter the Tavern</button>
</div>

<button id="exit-fullscreen" onclick="exitFullscreen()" style="display: none;">Exit âœ•</button>

<div class="container">
    <div id="view-intro">
        <!-- Scroll Selection Screen -->
        <div id="intro-book-select" class="hero-sheet" style="margin-top: 20px; padding: 40px; position: relative; overflow: hidden;">
            <!-- Animated background particles -->
            <div style="position: absolute; inset: 0; pointer-events: none; opacity: 0.15;">
                <div style="position: absolute; width: 2px; height: 2px; background: var(--gold); border-radius: 50%; top: 20%; left: 10%; animation: float 6s infinite ease-in-out;"></div>
                <div style="position: absolute; width: 2px; height: 2px; background: var(--gold); border-radius: 50%; top: 60%; left: 80%; animation: float 8s infinite ease-in-out 1s;"></div>
                <div style="position: absolute; width: 2px; height: 2px; background: var(--gold); border-radius: 50%; top: 40%; left: 90%; animation: float 7s infinite ease-in-out 2s;"></div>
            </div>
            
            <!-- Professional Logo Frame - Smaller -->
            <div style="position: relative; margin: 0 auto 25px; max-width: 420px; padding: 35px 25px;">
                <!-- Ornate corner decorations -->
                <div style="position: absolute; top: 0; left: 0; width: 45px; height: 45px; border-top: 2px solid #8e7b55; border-left: 2px solid #8e7b55; opacity: 0.8;">
                    <div style="position: absolute; top: -2px; left: -2px; width: 15px; height: 15px; border-top: 2px solid var(--gold); border-left: 2px solid var(--gold);"></div>
                </div>
                <div style="position: absolute; top: 0; right: 0; width: 45px; height: 45px; border-top: 2px solid #8e7b55; border-right: 2px solid #8e7b55; opacity: 0.8;">
                    <div style="position: absolute; top: -2px; right: -2px; width: 15px; height: 15px; border-top: 2px solid var(--gold); border-right: 2px solid var(--gold);"></div>
                </div>
                <div style="position: absolute; bottom: 0; left: 0; width: 45px; height: 45px; border-bottom: 2px solid #8e7b55; border-left: 2px solid #8e7b55; opacity: 0.8;">
                    <div style="position: absolute; bottom: -2px; left: -2px; width: 15px; height: 15px; border-bottom: 2px solid var(--gold); border-left: 2px solid var(--gold);"></div>
                </div>
                <div style="position: absolute; bottom: 0; right: 0; width: 45px; height: 45px; border-bottom: 2px solid #8e7b55; border-right: 2px solid #8e7b55; opacity: 0.8;">
                    <div style="position: absolute; bottom: -2px; right: -2px; width: 15px; height: 15px; border-bottom: 2px solid var(--gold); border-right: 2px solid var(--gold);"></div>
                </div>
                
                <!-- Subtle animated branch accents -->
                <svg style="position: absolute; top: 12px; left: 50%; transform: translateX(-50%); width: 150px; height: 25px; opacity: 0.6;" viewBox="0 0 150 25">
                    <path d="M 15 12 Q 45 8, 75 12 T 135 12" stroke="#5a4a3a" stroke-width="2" fill="none" stroke-linecap="round">
                        <animate attributeName="d" dur="4s" repeatCount="indefinite" 
                                 values="M 15 12 Q 45 8, 75 12 T 135 12;
                                         M 15 12 Q 45 10, 75 12 T 135 12;
                                         M 15 12 Q 45 8, 75 12 T 135 12"/>
                    </path>
                    <circle cx="45" cy="8" r="1.5" fill="#4a5a3a" opacity="0.7">
                        <animate attributeName="opacity" dur="3s" repeatCount="indefinite" values="0.7;0.4;0.7"/>
                    </circle>
                    <circle cx="105" cy="10" r="1.5" fill="#4a5a3a" opacity="0.7">
                        <animate attributeName="opacity" dur="3.5s" repeatCount="indefinite" values="0.7;0.4;0.7"/>
                    </circle>
                </svg>
                
                <svg style="position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%); width: 150px; height: 25px; opacity: 0.6;" viewBox="0 0 150 25">
                    <path d="M 15 12 Q 45 16, 75 12 T 135 12" stroke="#5a4a3a" stroke-width="2" fill="none" stroke-linecap="round">
                        <animate attributeName="d" dur="4.5s" repeatCount="indefinite" 
                                 values="M 15 12 Q 45 16, 75 12 T 135 12;
                                         M 15 12 Q 45 14, 75 12 T 135 12;
                                         M 15 12 Q 45 16, 75 12 T 135 12"/>
                    </path>
                    <circle cx="45" cy="16" r="1.5" fill="#4a5a3a" opacity="0.7">
                        <animate attributeName="opacity" dur="3.2s" repeatCount="indefinite" values="0.7;0.4;0.7"/>
                    </circle>
                    <circle cx="105" cy="14" r="1.5" fill="#4a5a3a" opacity="0.7">
                        <animate attributeName="opacity" dur="3.7s" repeatCount="indefinite" values="0.7;0.4;0.7"/>
                    </circle>
                </svg>
                
                <!-- Main title -->
                <div style="text-align: center; position: relative; z-index: 2;">
                    <div style="font-family: 'MedievalSharp', cursive; font-weight: 700; font-size: 24px; 
                               letter-spacing: 3px; line-height: 1.2; margin-bottom: 4px;
                               color: #3a2817;
                               text-shadow: 
                                   1px 1px 0px #5a3a1a,
                                   2px 2px 0px #4a2f15,
                                   3px 3px 5px rgba(0,0,0,0.5),
                                   0 0 10px rgba(90,58,26,0.3);
                               background: linear-gradient(to bottom, #5a3a1a 0%, #3a2817 40%, #2a1a0f 100%);
                               -webkit-background-clip: text;
                               -webkit-text-fill-color: transparent;
                               background-clip: text;">
                        MISSIONS
                    </div>
                    
                    <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin: 5px 0;">
                        <div style="width: 40px; height: 1px; background: linear-gradient(to right, transparent, #5a3a1a, transparent);"></div>
                        <div style="font-family: 'MedievalSharp', cursive; font-size: 10px; letter-spacing: 1px; color: #5a3a1a; font-weight: bold;">IN</div>
                        <div style="width: 40px; height: 1px; background: linear-gradient(to right, transparent, #5a3a1a, transparent);"></div>
                    </div>
                    
                    <div style="font-family: 'MedievalSharp', cursive; font-weight: 700; font-size: 24px; 
                               letter-spacing: 3px; line-height: 1.2;
                               color: #3a2817;
                               text-shadow: 
                                   1px 1px 0px #5a3a1a,
                                   2px 2px 0px #4a2f15,
                                   3px 3px 5px rgba(0,0,0,0.5),
                                   0 0 10px rgba(90,58,26,0.3);
                               background: linear-gradient(to bottom, #5a3a1a 0%, #3a2817 40%, #2a1a0f 100%);
                               -webkit-background-clip: text;
                               -webkit-text-fill-color: transparent;
                               background-clip: text;">
                        PAVEL
                    </div>
                </div>
                
                <!-- Subtitle -->
                <div style="text-align: center; margin-top: 12px; font-family: 'Almendra', serif; font-style: italic; 
                           font-size: 10px; letter-spacing: 2px; color: #7a6a4a; opacity: 0.9;">
                    A Tale of Heroes and Beer!
                </div>
            </div>
            
            <p style="text-align: center; font-style: italic; color: #5a4634; font-size: 14px; margin-bottom: 25px; animation: fadeIn 2s ease-in, float 4s ease-in-out infinite; position: relative; z-index: 1; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">Choose a scroll to begin your journey...</p>
            
            <div style="display: grid; gap: 20px; margin-bottom: 30px; position: relative; z-index: 1;" class="scroll-grid">
                <!-- Scroll 1: The World Map -->
                <div onclick="showBook(1)" class="scroll-btn" style="cursor: pointer; position: relative; height: 120px; perspective: 1000px; animation: slideInLeft 0.6s ease-out;">
                    <div class="book-3d" style="position: absolute; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform 0.3s;"
                         onmouseover="this.style.transform='rotateY(-5deg) translateZ(10px) scale(1.02)'" 
                         onmouseout="this.style.transform='rotateY(0deg) translateZ(0px) scale(1)'">
                        <!-- Scroll spine/side -->
                        <div style="position: absolute; left: 0; width: 20px; height: 100%; background: linear-gradient(to right, #3a2a1a, #5a4a3a); border-radius: 3px 0 0 3px; transform: translateZ(-10px);"></div>
                        <!-- Scroll cover -->
                        <div style="position: absolute; left: 20px; right: 0; height: 100%; background: linear-gradient(135deg, #4a3520 0%, #6b5030 50%, #4a3520 100%); 
                                    border: 3px solid #8e7b55; border-radius: 0 5px 5px 0; padding: 20px; box-shadow: 5px 5px 15px rgba(0,0,0,0.5), inset -2px 0 10px rgba(0,0,0,0.3);
                                    display: flex; flex-direction: column; justify-content: center; position: relative; overflow: hidden;">
                            <!-- Shine effect -->
                            <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%); animation: shine 3s infinite;"></div>
                            <h3 style="color: #f3cf7a; margin: 0 0 8px 0; font-size: 20px; text-shadow: 2px 2px 4px #000, 0 0 10px rgba(243, 207, 122, 0.5); position: relative; animation: glow 3s ease-in-out infinite;">ðŸ“œ The World Map</h3>
                            <p style="font-size: 12px; margin: 0; color: #d4c3a3; line-height: 1.3; position: relative;">Explore the lands surrounding Pavel and understand the geography of this realm.</p>
                        </div>
                        <!-- Scroll pages effect -->
                        <div style="position: absolute; right: 8px; top: 5px; bottom: 5px; width: 3px; background: repeating-linear-gradient(to bottom, #f4e4c4 0px, #f4e4c4 1px, transparent 1px, transparent 2px); opacity: 0.6;"></div>
                    </div>
                </div>
                
                <!-- Scroll 2: Pavel Town -->
                <div onclick="showBook(2)" class="scroll-btn" style="cursor: pointer; position: relative; height: 120px; perspective: 1000px; animation: slideInLeft 0.8s ease-out;">
                    <div class="book-3d" style="position: absolute; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform 0.3s;"
                         onmouseover="this.style.transform='rotateY(-5deg) translateZ(10px) scale(1.02)'" 
                         onmouseout="this.style.transform='rotateY(0deg) translateZ(0px) scale(1)'">
                        <!-- Scroll spine/side -->
                        <div style="position: absolute; left: 0; width: 20px; height: 100%; background: linear-gradient(to right, #2a1a1a, #4a3a3a); border-radius: 3px 0 0 3px; transform: translateZ(-10px);"></div>
                        <!-- Scroll cover -->
                        <div style="position: absolute; left: 20px; right: 0; height: 100%; background: linear-gradient(135deg, #3a2020 0%, #5a3030 50%, #3a2020 100%); 
                                    border: 3px solid #8e7b55; border-radius: 0 5px 5px 0; padding: 20px; box-shadow: 5px 5px 15px rgba(0,0,0,0.5), inset -2px 0 10px rgba(0,0,0,0.3);
                                    display: flex; flex-direction: column; justify-content: center; position: relative; overflow: hidden;">
                            <!-- Shine effect -->
                            <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%); animation: shine 3s infinite 1s;"></div>
                            <h3 style="color: #f3cf7a; margin: 0 0 8px 0; font-size: 20px; text-shadow: 2px 2px 4px #000, 0 0 10px rgba(243, 207, 122, 0.5); position: relative; animation: glow 3s ease-in-out infinite;">ðŸ“œ Pavel Town</h3>
                            <p style="font-size: 12px; margin: 0; color: #d4c3a3; line-height: 1.3; position: relative;">Learn about the village, its people, and the legends who call Pavel home.</p>
                        </div>
                        <!-- Scroll pages effect -->
                        <div style="position: absolute; right: 8px; top: 5px; bottom: 5px; width: 3px; background: repeating-linear-gradient(to bottom, #f4e4c4 0px, #f4e4c4 1px, transparent 1px, transparent 2px); opacity: 0.6;"></div>
                    </div>
                </div>
                
                <!-- Scroll 3: The Heroes -->
                <div onclick="showBook(3)" class="scroll-btn" style="cursor: pointer; position: relative; height: 120px; perspective: 1000px; animation: slideInLeft 1s ease-out;">
                    <div class="book-3d" style="position: absolute; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform 0.3s;"
                         onmouseover="this.style.transform='rotateY(-5deg) translateZ(10px) scale(1.02)'" 
                         onmouseout="this.style.transform='rotateY(0deg) translateZ(0px) scale(1)'">
                        <!-- Scroll spine/side -->
                        <div style="position: absolute; left: 0; width: 20px; height: 100%; background: linear-gradient(to right, #1a1a2a, #3a3a4a); border-radius: 3px 0 0 3px; transform: translateZ(-10px);"></div>
                        <!-- Scroll cover -->
                        <div style="position: absolute; left: 20px; right: 0; height: 100%; background: linear-gradient(135deg, #2a2040 0%, #3a3060 50%, #2a2040 100%); 
                                    border: 3px solid #8e7b55; border-radius: 0 5px 5px 0; padding: 20px; box-shadow: 5px 5px 15px rgba(0,0,0,0.5), inset -2px 0 10px rgba(0,0,0,0.3);
                                    display: flex; flex-direction: column; justify-content: center; position: relative; overflow: hidden;">
                            <!-- Shine effect -->
                            <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%); animation: shine 3s infinite 1.5s;"></div>
                            <h3 style="color: #f3cf7a; margin: 0 0 8px 0; font-size: 20px; text-shadow: 2px 2px 4px #000, 0 0 10px rgba(243, 207, 122, 0.5); position: relative; animation: glow 3s ease-in-out infinite;">ðŸ“œ The Heroes</h3>
                            <p style="font-size: 12px; margin: 0; color: #d4c3a3; line-height: 1.3; position: relative;">Meet the legendary warriors who gather at Pavel's tavern seeking glory.</p>
                        </div>
                        <!-- Scroll pages effect -->
                        <div style="position: absolute; right: 8px; top: 5px; bottom: 5px; width: 3px; background: repeating-linear-gradient(to bottom, #f4e4c4 0px, #f4e4c4 1px, transparent 1px, transparent 2px); opacity: 0.6;"></div>
                    </div>
                </div>
                
                <!-- Scroll 4: Game Rules -->
                <div onclick="showBook(4)" class="scroll-btn" style="cursor: pointer; position: relative; height: 120px; perspective: 1000px; animation: slideInLeft 1.2s ease-out;">
                    <div class="book-3d" style="position: absolute; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform 0.3s;"
                         onmouseover="this.style.transform='rotateY(-5deg) translateZ(10px) scale(1.02)'" 
                         onmouseout="this.style.transform='rotateY(0deg) translateZ(0px) scale(1)'">
                        <!-- Scroll spine/side -->
                        <div style="position: absolute; left: 0; width: 20px; height: 100%; background: linear-gradient(to right, #1a2a1a, #3a4a3a); border-radius: 3px 0 0 3px; transform: translateZ(-10px);"></div>
                        <!-- Scroll cover -->
                        <div style="position: absolute; left: 20px; right: 0; height: 100%; background: linear-gradient(135deg, #203a20 0%, #305a30 50%, #203a20 100%); 
                                    border: 3px solid #8e7b55; border-radius: 0 5px 5px 0; padding: 20px; box-shadow: 5px 5px 15px rgba(0,0,0,0.5), inset -2px 0 10px rgba(0,0,0,0.3);
                                    display: flex; flex-direction: column; justify-content: center; position: relative; overflow: hidden;">
                            <!-- Shine effect -->
                            <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%); animation: shine 3s infinite 2s;"></div>
                            <h3 style="color: #f3cf7a; margin: 0 0 8px 0; font-size: 20px; text-shadow: 2px 2px 4px #000, 0 0 10px rgba(243, 207, 122, 0.5); position: relative; animation: glow 3s ease-in-out infinite;">ðŸ“œ Game Rules</h3>
                            <p style="font-size: 12px; margin: 0; color: #d4c3a3; line-height: 1.3; position: relative;">Understand the mechanics, missions, and how to achieve victory.</p>
                        </div>
                        <!-- Scroll pages effect -->
                        <div style="position: absolute; right: 8px; top: 5px; bottom: 5px; width: 3px; background: repeating-linear-gradient(to bottom, #f4e4c4 0px, #f4e4c4 1px, transparent 1px, transparent 2px); opacity: 0.6;"></div>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-main" onclick="showSetup()" style="font-size: 16px; padding: 20px; animation: pulse 2s ease-in-out infinite; position: relative; z-index: 1;">ENTER THE MISSIONS</button>
        </div>
            <button class="btn btn-danger" onclick="resetHallOfFame()" style="font-size: 10px; margin-top: 40px; opacity: 0.6;">Reset Hall of Fame</button>

        <!-- Scroll 1: The World Map -->
        <div id="intro-book-1" class="hero-sheet book-container" style="margin-top: 20px; display: none;">
            <h1 class="book-title medieval" style="color: var(--gold);">THE WORLD MAP</h1>
            <p class="book-subtitle">The Lands Surrounding Pavel</p>
            <hr class="book-divider">
            
            <!-- Map Image - Full Width Responsive -->
            <div class="map-container">
                <img src="./images/map.png" alt="Map of Pavel">
            </div>
            
            <div class="book-text">
                <p><b>Pavel Town</b> sits at the heart of a vast realm, surrounded by ancient forests that stretch in every direction. To those who know where to look, pathways wind through these woods to distant lands.</p>

                <p>Hidden within the <b>Misty Forest</b>, where trees grow tall and fog never lifts, wander the <b>Nomads of the Ninja and Elven</b>. These elusive peoples guard forgotten routes and tend the forest's magic.</p>
                
                <p><b>To the Northeast</b>, beyond the clouds, floats the mystical <b>Lost Dragon Town</b>. This ethereal city hovers in the sky, home to ancient dragons who have lived for centuries.</p>
                
                <p><b>To the West</b> stand the imposing walls of the <b>Ork Fortress</b>, built from dark stone in the <b>Westlands</b>. The orks have found common ground with Pavel's people over strong drink and stronger stories.</p>
                
                <p><b>To the Southeast</b> lie the <b>Monk Monasteries</b>, peaceful sanctuaries of meditationâ€”and occasional pilgrimages to Pavel's famous tavern.</p>
                
                <p><b>To the Southwest</b>, shrouded in mist, are the <b>High Dwarvish Mountains</b>. The dwarves here are master craftsmen, their ales second only to Pavel's own.</p>
                
                <p>But between Pavel and safety lie <b>the Swamps</b>â€”a treacherous expanse where trolls lurk in shadows, emerging to raid the village. Many heroes have ventured in, but the mist keeps its secrets well.</p>
            </div>
            
            <button class="btn btn-main" onclick="showBookSelect()" style="margin-top: 15px; width: 100%;">Return to Scrolls</button>
        </div>

        <!-- Scroll 2: Pavel Town -->
        <div id="intro-book-2" class="hero-sheet book-container" style="margin-top: 20px; display: none;">
            <h1 class="book-title medieval">PAVEL TOWN</h1>
            <p class="book-subtitle">The Town of Beer and Fellowship</p>
            <hr class="book-divider">
            
            <div class="book-text">
                <p>In the heart of a realm where ancient forests whisper forgotten secrets, there lies <b>Pavel</b>â€”a humble settlement of five thousand souls, united by one truth: there is no problem that cannot be solved with good company and a cold mug of ale.</p>
            </div>
            
            <div class="location-card">
                <p class="location-card-title">ðŸ‘‘ King Antony - The Peaceful King</p>
                <p class="location-card-text">While neighboring monarchs concern themselves with conquest, Antony has but two ambitions: keeping his village peaceful and his tankard full. You'll find him at the tavern's corner table, buying rounds for travelers. "A happy village is a peaceful village," he declares.</p>
            </div>
            
            <div class="location-card">
                <p class="location-card-title">ðŸ“– Old Nick the Geezer - Keeper of Tales</p>
                <p class="location-card-text">Every night, Old Nick takes his seat by the hearth. With a voice weathered by a hundred winters, he weaves tales of when forests were deeper and monsters bolder. Some say he's too stubborn to let death interrupt a good story.</p>
            </div>
            
            <div class="location-card">
                <p class="location-card-title">ðŸº Panchonco & Yuumi - The Eternal Patron</p>
                <p class="location-card-text">Propped against the bar with his cat Yuumi on his shoulder, Panchonco haunts the pub day and night. Yuumi seems the only creature who understands his slurred philosophy. Some say he's been drinking since before King Antony was born.</p>
            </div>
            
            <div class="location-card">
                <p class="location-card-title">ðŸŒ The Visitors</p>
                <p class="location-card-text">Pavel's fame has spread across the realm. <b>Dragons</b> descend from Lost Dragon Town. <b>Orcs</b> march from their Fortress, war cries replaced with drinking songs. <b>Monks</b> find enlightenment tastes like honey mead. Even <b>Dwarves</b> emerge from misty mountains.</p>
            </div>
            
            <div class="location-card" style="border-left-color: #8b0000; background: linear-gradient(135deg, #fff0f0 0%, #ffe8e8 100%);">
                <p class="location-card-title">âš ï¸ The Threat</p>
                <p class="location-card-text">In <b>the Swamps</b> lurk <b>trolls</b>â€”brutal creatures who strike without warning. Their raids are swift and merciless. Many have ventured into those marshes, but few return, and those who do speak in whispers of what dwells in the deepest shadows.</p>
            </div>
            
            <button class="btn btn-main" onclick="showBookSelect()" style="margin-top: 15px; width: 100%;">Return to Scrolls</button>
        </div>
        </div>

        <!-- Scroll 3: The Heroes -->
        <div id="intro-book-3" class="hero-sheet book-container" style="margin-top: 20px; display: none;">
            <h1 class="book-title medieval">THE HEROES OF PAVEL</h1>
            <p class="book-subtitle">Legendary Warriors Seeking Glory</p>
            <hr class="book-divider">
            
            <!-- Dark Stalker -->
            <div class="hero-card">
                <div class="hero-card-top">
                    <img src="./images/dark.png" class="hero-card-img" alt="Dark Stalker">
                    <div class="hero-card-info">
                        <p class="hero-card-name">Dark Stalker</p>
                        <span class="hero-card-stats">5/5/5/5/5</span>
                    </div>
                </div>
                <p class="hero-card-desc">Perfectly balanced assassin. No one knows their true face or purpose.</p>
                <p class="hero-card-ability"><b>âš¡ Shadow Control:</b> Force a player to use a meditation. Uses: 1-3 based on party size.</p>
            </div>
            
            <!-- Friendly AI -->
            <div class="hero-card">
                <div class="hero-card-top">
                    <img src="./images/ai.png" class="hero-card-img" alt="Friendly AI">
                    <div class="hero-card-info">
                        <p class="hero-card-name">Friendly AI</p>
                        <span class="hero-card-stats">6/5/6/2/6</span>
                    </div>
                </div>
                <p class="hero-card-desc">Sentient construct from a forgotten age. Analyzes problems with inhuman precision.</p>
                <p class="hero-card-ability"><b>âš¡ System Override:</b> Use ANY stat for a challenge. Recharges on friend challenge win.</p>
            </div>
            
            <!-- Thug Dwarf -->
            <div class="hero-card">
                <div class="hero-card-top">
                    <img src="./images/swag.png" class="hero-card-img" alt="Thug Dwarf">
                    <div class="hero-card-info">
                        <p class="hero-card-name">Thug Dwarf</p>
                        <span class="hero-card-stats">7/2/2/5/6</span>
                    </div>
                </div>
                <p class="hero-card-desc">Exiled from Ironpeak clans. Hit first, hit hard, never apologize.</p>
                <p class="hero-card-ability"><b>âš¡ Brute Force:</b> Gain +3 POW permanently every time you win. Always active.</p>
            </div>
            
            <!-- Babbler Rogue -->
            <div class="hero-card">
                <div class="hero-card-top">
                    <img src="./images/rogue.png" class="hero-card-img" alt="Babbler Rogue">
                    <div class="hero-card-info">
                        <p class="hero-card-name">Babbler Rogue</p>
                        <span class="hero-card-stats">2/4/5/8/6</span>
                    </div>
                </div>
                <p class="hero-card-desc">Silver-tongued trickster who can talk their way out of anything.</p>
                <p class="hero-card-ability"><b>âš¡ Crowd Favorite:</b> +1 bonus Glory for every 3 challenges completed. Always active.</p>
            </div>
            
            <!-- Neighbor Witch -->
            <div class="hero-card">
                <div class="hero-card-top">
                    <img src="./images/magic.png" class="hero-card-img" alt="Neighbor Witch">
                    <div class="hero-card-info">
                        <p class="hero-card-name">Neighbor Witch</p>
                        <span class="hero-card-stats">2/3/8/4/7</span>
                    </div>
                </div>
                <p class="hero-card-desc">Lives in the crooked cottage at the edge of town. Helpful to the polite, terrifying to others.</p>
                <p class="hero-card-ability"><b>âš¡ Arcane Alliance:</b> Steal 1-3 stat points permanently from any player. Recharges after 3 wins.</p>
            </div>
            
            <!-- Fancy Ninja -->
            <div class="hero-card">
                <div class="hero-card-top">
                    <img src="./images/ninja.png" class="hero-card-img" alt="Fancy Ninja">
                    <div class="hero-card-info">
                        <p class="hero-card-name">Fancy Ninja</p>
                        <span class="hero-card-stats">4/7/5/3/5</span>
                    </div>
                </div>
                <p class="hero-card-desc">Stylish assassin who values dramatic entrances. Every kill is a performance.</p>
                <p class="hero-card-ability"><b>âš¡ Assassination Contract:</b> Bet on a player failing. Win: steal +1 stat. Lose: -1 stat.</p>
            </div>
            
            <!-- Lost Dragon -->
            <div class="hero-card">
                <div class="hero-card-top">
                    <img src="./images/dragon.png" class="hero-card-img" alt="Lost Dragon">
                    <div class="hero-card-info">
                        <p class="hero-card-name">Lost Dragon</p>
                        <span class="hero-card-stats">8/5/4/3/3</span>
                    </div>
                </div>
                <p class="hero-card-desc">Last of the sky-born warriors. Devastating power but fragile spirit.</p>
                <p class="hero-card-ability"><b>âš¡ Dragon Rage:</b> When spending 4+ points, gain +3 bonus. Always active.</p>
            </div>
            
            <!-- Drunken Paladin -->
            <div class="hero-card">
                <div class="hero-card-top">
                    <img src="./images/paladin.png" class="hero-card-img" alt="Drunken Paladin">
                    <div class="hero-card-info">
                        <p class="hero-card-name">Drunken Paladin</p>
                        <span class="hero-card-stats">3/2/3/8/7</span>
                    </div>
                </div>
                <p class="hero-card-desc">Holy knight who found divine inspiration flows better after a few tankards.</p>
                <p class="hero-card-ability"><b>âš¡ Liquid Courage:</b> Once per stage, roll dice. 5-6 = instant win! Resets each stage.</p>
            </div>
            
            <!-- Mute Monk -->
            <div class="hero-card">
                <div class="hero-card-top">
                    <img src="./images/monk.png" class="hero-card-img" alt="Mute Monk">
                    <div class="hero-card-info">
                        <p class="hero-card-name">Mute Monk</p>
                        <span class="hero-card-stats">3/3/9/6/7</span>
                    </div>
                </div>
                <p class="hero-card-desc">Took a sacred vow of silence 30 years ago. Communicates through meaningful stares.</p>
                <p class="hero-card-ability"><b>âš¡ Inner Peace:</b> When meditating, choose any stat to restore +4. Always active.</p>
            </div>
            
            <!-- Lover Zombie -->
            <div class="hero-card">
                <div class="hero-card-top">
                    <img src="./images/zombie.png" class="hero-card-img" alt="Lover Zombie">
                    <div class="hero-card-info">
                        <p class="hero-card-name">Lover Zombie</p>
                        <span class="hero-card-stats">9/2/4/3/8</span>
                    </div>
                </div>
                <p class="hero-card-desc">Died for love, rose from the grave. Terrifyingly strong, surprisingly gentle.</p>
                <p class="hero-card-ability"><b>âš¡ Cursed Embrace:</b> When you win, all others lose -2 from a stat you choose, you gain +1.</p>
            </div>
            
            <button class="btn btn-main" onclick="showBookSelect()" style="margin-top: 15px; width: 100%;">Return to Scrolls</button>
        </div>

        <!-- Scroll 4: Game Rules -->
        <div id="intro-book-4" class="hero-sheet" style="margin-top: 20px; padding: 30px; display: none; overflow-y: auto; max-height: 80vh;">
            <h1 style="color:var(--blood); text-align: center; font-size: 28px; animation: glow 3s ease-in-out infinite; text-shadow: 2px 2px 4px #000, 0 0 15px rgba(139, 0, 0, 0.6);">GAME RULES</h1>
            <p style="text-align: center; font-style: italic; color: #5a4634; font-size: 12px; margin-bottom: 10px; animation: float 4s ease-in-out infinite;">Complete Guide to the Missions of Pavel</p>
            <hr style="border: 0; border-top: 2px double #8e7b55; margin: 20px 0;">
            <div class="instruction-text" style="text-align: justify;">
                
                <p style="font-style: italic; margin-bottom: 15px; background: rgba(139,0,0,0.1); padding: 10px; border-left: 3px solid var(--blood);"><b>The Setup:</b> Ten legendary heroes gather at Pavel's tavern, each with unique abilities and soul affinities. King Antony has announced a grand competition - a series of Missions where heroes prove their worth through trials of strength, speed, intellect, charisma, and willpower.</p>
                
                <p style="margin-top: 15px;"><b style="color: var(--blood); font-size: 14px;">ðŸŽ¯ OBJECTIVE</b></p>
                <p>Accumulate the highest <b>Glory</b> score by completing challenges. The hero with the most Glory when all missions are complete wins!</p>
                
                <p style="margin-top: 15px;"><b style="color: var(--blood); font-size: 14px;">ðŸ“œ ROUNDS & STAGES</b></p>
                <p>The game is divided into <b>Rounds</b>. Each Round consists of multiple <b>Stages</b> (one per player). A new Round begins when the original first Reader becomes Reader again - meaning everyone has read once.</p>
                
                <p style="margin-top: 15px;"><b style="color: var(--blood); font-size: 14px;">ðŸ‘¤ THE READER</b></p>
                <p>Each stage has a <b>Reader</b> who:</p>
                <p style="margin-left: 15px;">â€¢ Draws and reads the mission card aloud</p>
                <p style="margin-left: 15px;">â€¢ Rolls the Fate Dice to determine difficulty (1-3 = Easy, 4-6 = Hard)</p>
                <p style="margin-left: 15px;">â€¢ Knows the secret target number</p>
                <p style="margin-left: 15px;">â€¢ <b>Does NOT participate</b> in regular challenges, Challenge a Friend, or Group Missions</p>
                <p style="margin-left: 15px;">â€¢ <b>CAN be targeted</b> by abilities (Shadow Control, Arcane Alliance, etc.)</p>
                
                <p style="margin-top: 15px;"><b style="color: var(--blood); font-size: 14px;">âš”ï¸ CHALLENGE OPTIONS</b></p>
                <p>When it's your turn as Challenger, you have three choices:</p>
                
                <p style="margin-top: 10px; margin-left: 10px;"><b>1. ATTEMPT THE CHALLENGE</b></p>
                <p style="margin-left: 20px;">â€¢ Spend stat points to meet or exceed the secret target</p>
                <p style="margin-left: 20px;">â€¢ <b>Win:</b> Gain Glory (1 Easy / 2 Hard) + get back 2 spent points</p>
                <p style="margin-left: 20px;">â€¢ <b>Fail:</b> Lose all spent points, challenge passes to next player</p>
                
                <p style="margin-top: 10px; margin-left: 10px;"><b>2. MEDITATE (PASS)</b></p>
                <p style="margin-left: 20px;">â€¢ Skip the challenge without spending points</p>
                <p style="margin-left: 20px;">â€¢ You have exactly <b>3 Meditations</b> for the entire game</p>
                <p style="margin-left: 20px;">â€¢ Challenge passes to next player</p>
                
                <p style="margin-top: 10px; margin-left: 10px;"><b>3. CHALLENGE A FRIEND</b></p>
                <p style="margin-left: 20px;">â€¢ Challenge another player (not the Reader) to a duel</p>
                <p style="margin-left: 20px;">â€¢ Initiator gets <b>+3 Courage Bonus</b></p>
                <p style="margin-left: 20px;">â€¢ Both players secretly invest points, then reveal</p>
                <p style="margin-left: 20px;">â€¢ <b>Both Win:</b> Both gain Glory</p>
                <p style="margin-left: 20px;">â€¢ <b>One Wins:</b> Winner gains +1 bonus Glory</p>
                <p style="margin-left: 20px;">â€¢ <b>Both Fail:</b> No Glory awarded</p>
                <p style="margin-left: 20px;">â€¢ After resolution, a <b>new challenge opens</b> for remaining players</p>
                
                <p style="margin-top: 15px;"><b style="color: var(--blood); font-size: 14px;">ðŸ¤ GROUP MISSIONS</b></p>
                <p>Special missions marked with ðŸ¤ require <b>ALL heroes to contribute</b>:</p>
                <p style="margin-left: 15px;">â€¢ Reader cannot contribute (only reads)</p>
                <p style="margin-left: 15px;">â€¢ All contributions are combined (including affinity bonuses)</p>
                <p style="margin-left: 15px;">â€¢ <b>Success:</b> Everyone gains +2 Glory (Easy) or +4 Glory (Hard)</p>
                <p style="margin-left: 15px;">â€¢ <b>Failure:</b> Everyone loses <b>-3 to ALL stats</b>!</p>
                
                <p style="margin-top: 15px;"><b style="color: var(--blood); font-size: 14px;">âœ¨ SOUL-TYPE AFFINITY</b></p>
                <p>Each hero has a secret Soul-Type. If your Soul-Type matches the challenge's affinity, you receive a <b>+3 automatic bonus</b>. Soul-Types are secret!</p>
                
                <p style="margin-top: 15px;"><b style="color: var(--blood); font-size: 14px;">ðŸ§ª THE ALCHEMIST SHOP</b></p>
                <p>Periodically, the Alchemist appears to restore your stats:</p>
                <p style="margin-left: 15px;">â€¢ Distribute <b>10 points</b> across any stats (max +5 per stat)</p>
                <p style="margin-left: 15px;">â€¢ Shop frequency depends on party size</p>
                <p style="margin-left: 15px;">â€¢ This is your primary recovery - plan accordingly!</p>
                
                <p style="margin-top: 15px;"><b style="color: var(--blood); font-size: 14px;">âš¡ HERO ABILITIES</b></p>
                <p>Each hero has a unique passive ability (see Heroes scroll for details). Some abilities:</p>
                <p style="margin-left: 15px;">â€¢ Are always active (Dragon Rage, Brute Force)</p>
                <p style="margin-left: 15px;">â€¢ Require activation and recharge (System Override, Arcane Alliance)</p>
                <p style="margin-left: 15px;">â€¢ Can target other players including the Reader</p>
                <p style="margin-left: 15px;">â€¢ Reset or recharge based on specific conditions</p>
                
                <p style="margin-top: 15px; color: var(--gold); background: rgba(197,160,89,0.1); padding: 10px; border: 1px solid var(--gold);"><b>ðŸ’¡ STRATEGY TIPS:</b> Balance Glory gains against resource sustainability. Identify which challenges favor your Soul-Type. Save Meditations for impossible trials. Use Challenge a Friend strategically to share difficult challenges. In Group Missions, coordinate with your party - failure hurts everyone!</p>
            </div>
            <button class="btn btn-main" onclick="showBookSelect()" style="margin-top: 20px;">Return to Scrolls</button>
    </div>

    </div>
    <div id="view-setup" style="display:none;">
        <div class="stage-frame" style="margin-top: 60px;">
            <h1></h1>
            <p class="medieval" style="font-size: 12px; color: #888; letter-spacing: 4px;">Pavel</p>
            <div style="margin: 30px 0;">
                <label class="medieval" style="display:block; font-size: 12px;">Party Size</label>
                <input type="number" id="p-count-in" value="3" min="2" max="10" class="input-hero" style="width: 80px; font-size:30px; text-align:center; color: var(--gold);">
                <p style="font-size: 11px; color: #888; margin-top: 10px;">âš ï¸ Group missions require 3+ players</p>
            </div>
            <button class="btn btn-main" onclick="startReg()">Gather Souls</button>
        </div>
    </div>

    <div id="view-reg" style="display:none;">
        <div class="hero-sheet" style="margin-top: 80px; text-align: center; padding: 40px 20px;">
            <p id="reg-subtitle" class="medieval" style="font-size:14px; text-transform: uppercase;">Scribing the Soul...</p>
            <input type="text" id="p-name-in" placeholder="Identity" class="input-hero" style="width:100%; font-size:24px; text-align:center; margin: 25px 0;">
            <button class="btn btn-main" onclick="handleReg()">Confirm Sigil</button>
        </div>
    </div>

    <div id="view-deck" style="display:none;">
        <div class="stage-frame" style="margin-top: 80px;">
            <h2 class="medieval">Quest Length</h2>
            <input type="number" id="deck-size-in" value="10" min="5" max="70" class="input-hero" style="width: 100px; color:white; font-size:35px; text-align:center; margin: 20px 0; background: none;">
            <button class="btn btn-main" onclick="startGame()">Commence Descent</button>
        </div>
    </div>

    <div id="view-game" style="display:none;">
        <!-- Round Counter and Shop Countdown -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 8px 12px; background: rgba(0,0,0,0.4); border: 1px solid #444; border-radius: 5px;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 11px; color: #888; font-family: 'Cinzel Decorative'; letter-spacing: 1px;">ROUND</span>
                <span id="round-counter" style="font-size: 18px; color: var(--gold); font-family: 'Cinzel Decorative'; font-weight: bold;">0/10</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 20px;">ðŸ§ª</span>
                <div style="text-align: right;">
                    <div style="font-size: 9px; color: #888; font-family: 'MedievalSharp'; letter-spacing: 0.5px;">ALCHEMIST IN</div>
                    <div id="shop-countdown-number" style="font-size: 16px; color: var(--gold); font-family: 'Cinzel Decorative'; font-weight: bold;">?</div>
                </div>
            </div>
        </div>
        <div class="progress-map"><div id="prog-bar" class="progress-marker"></div></div>
        <div class="stage-frame">
            <span id="turn-label" class="medieval" style="font-size:11px; color:var(--gold-bright); letter-spacing: 2px;"></span>
            <h2 id="st-title" class="st-title">???</h2>
            <p id="st-desc" class="st-desc"></p>
            <div id="st-req" style="color: var(--gold-bright); font-size: 11px; margin-top:15px; font-weight:bold; letter-spacing:1px; border: 1px double var(--gold); display:inline-block; padding: 4px 15px; background: rgba(0,0,0,0.3);"></div>
        </div>
        <button id="draw-btn" class="btn btn-main" onclick="readerOpensMission()">ðŸ“œ Open a Mission (Reader)</button>
        <div id="game-controls" style="display:none;">
            <button id="btn-fight" class="btn btn-fight" onclick="startFight()">Do the Challenge</button>
            <button id="btn-skip" class="btn btn-skip" onclick="meditateTurn()">Pass (Meditate)</button>
            <button id="btn-discard" class="btn btn-danger" onclick="initiateFriendChallenge()">Challenge a Friend</button>
        </div>
        <div id="party-list" style="margin-top: 30px;"></div>
    </div>
</div>

<div id="overlay" class="overlay"><div class="modal" id="modal"></div></div>

<script>
// ============================================================
// GAME DATA - Challenges and Heroes
// ============================================================

const STAGES = [
    {t: "Iron Portcullis", d: "A heavy gate slams down. Only brute strength can lift it.", s: "pow", e: 4, h: 6, a: 'stone'},
    {t: "The Pub Haul", d: "Move barrels of beer to pub's storage.", s: "pow", e: 2, h: 4, a: 'pub'},
    {t: "Missing Feline", d: "Find Yuumi. Drunk Panchoncho's cat.", s: "wil", e: 2, h: 4, a: 'pub'},
    {t: "Boulder Obstacle", d: "Your path is blocked by a rock. Move it.", s: "pow", e: 4, h: 9, a: 'stone'},
    {t: "Tavern Brawl", d: "Restrain the drunken ork before it destroys the bar.", s: "pow", e: 3, h: 5, a: 'pub'},
    {t: "The Bell Sprint", d: "Whoever ring the pub's bell faster wins a beer.", s: "spd", e: 4, h: 9, a: 'pub'},
    {t: "Dwarven Anvil", d: "Shape the hot metal with physical force.", s: "pow", e: 5, h: 9, a: 'stone'},
    {t: "Nightly Pub Run", d: "Walk fast through the forest to go to the pub at night.", s: "spd", e: 4, h: 7, a: ['dark','shadow']},
    {t: "The Beer Tribute", d: "Go to pub and bring to king Antony 100 beers.", s: "wil", e: 2, h: 4, a: ['pub','crowd']},
    {t: "Shadowy Cellar", d: "The darkness is alive. Run before it catches you.", s: "spd", e: 5, h: 9, a: 'dark'},
    {t: "Skybridge Cross", d: "Cross the thin rope bridge high in the clouds.", s: "wil", e: 5, h: 8, a: 'sky'},
    {t: "Royal Mediator", d: "King Antony is drunk again. Help him befriend with an ork.", s: "cha", e: 4, h: 8, a: ['pub','crowd']},
    {t: "The Pub Inferno", d: "Pub is on fire! You must rescue the drunk ones!", s: "brn", e: 5, h: 8, a: 'shadow'},
    {t: "Counter Coin Catch", d: "Dozens of coins fall from pub's bar. Catch them.", s: "spd", e: 4, h: 6, a: 'shadow'},
    {t: "Village Exodus", d: "FIRE! Navigate the villagers to the nearest safe city.", s: "brn", e: 5, h: 10, a: ['magic','tech']},
    {t: "The Racoon Thief", d: "A racoon stole your food. Chase them through the pub.", s: "spd", e: 3, h: 6, a: ['sky','shadow']},
    {t: "Drunken Tab", d: "You are drunk! Calculate the pub's bill correct!", s: "wil", e: 2, h: 4, a: 'pub'},
    {t: "Map Mastery", d: "Find the exit in a shifting, lightless labyrinth.", s: "brn", e: 5, h: 10, a: ['dark', 'shadow']},
    {t: "Sky Diplomacy", d: "The dragon tribe wants to invade. Negotiate with them.", s: "brn", e: 4, h: 8, a: ['sky', 'crowd']},
    {t: "Panchonco's Cocktail", d: "Panchonco wants a cocktail. Combine drinks.", s: "brn", e: 3, h: 6, a: 'pub'},
    {t: "King's Favor", d: "Impress the drunken King with a fake story.", s: "cha", e: 3, h: 6, a: ['crowd', 'pub']},
    {t: "The Nick Flattery", d: "Befriend old man Nick with flattery.", s: "cha", e: 3, h: 6, a: ['pub','crowd']},
    {t: "Bouncer Talk", d: "Charm the stone golem into letting you pass.", s: "cha", e: 5, h: 10, a: ['crowd','magic']},
    {t: "Panchonco's Song", d: "Sing a song that brings drunken Panchoncho to tears.", s: "cha", e: 4, h: 8, a: 'pub'},
    {t: "Shadow Whisper", d: "Convince forest's dark spirits to light the way.", s: "cha", e: 4, h: 7, a: ['crowd']},
    {t: "Aristocrat Snare", d: "End the boring conversation without being rude.", s: "cha", e: 3, h: 6, a: 'crowd'},
    {t: "Divine Toast", d: "Scream so loud that gods listen to you.", s: "cha", e: 5, h: 10, a: 'sky'},
    {t: "Tavern Temptation", d: "The beer smells of heaven. Stay focused.", s: "wil", e: 3, h: 6, a: ['undead', 'silent']},
    {t: "The Void Whisper", d: "Voices promise power for your soul. Resist?", s: "wil", e: 4, h: 8, a: ['dark','undead']},
    {t: "Monastic Silence", d: "Sit still while insects crawl on your skin.", s: "wil", e: 3, h: 6, a: ['silent','dark','undead']},
    {t: "Beggar's Test", d: "Old Nick asks for your last money. Resist and go!", s: "wil", e: 2, h: 4, a: 'crowd'},
    {t: "Molten Spirit", d: "Pub's floor is collapsing. Calm and cross!", s: "wil", e: 5, h: 10, a: ['sky', 'silent']},
    {t: "Royal Beer Fight", d: "Win a beer fight against king Antony!", s: "wil", e: 3, h: 6, a: 'pub'},
    {t: "Barrel Avalanche", d: "Beer barrels roll down the pub stairs. Dodge them all!", s: "spd", e: 4, h: 8, a: ['magic','shadow']},
    {t: "Stampeding Cattle", d: "Yuumi got your keys. CATCH HER!", s: "spd", e: 3, h: 6, a: ['shadow']},
    {t: "Dragon's Breath", d: "You vs yuumi. Who is faster!", s: "spd", e: 3, h: 6, a: 'shadow'},
    {t: "Pub Rat Race", d: "Catch Yuumi before Panchoncho notices she's gone!", s: "spd", e: 3, h: 5, a: ['pub','shadow']},
    {t: "Giant's Arm Wrestling", d: "A drunken dragon challenges you. Show your strength!", s: "pow", e: 5, h: 10, a: ['stone','sky','undead']},
    {t: "Fight with Panchonco?", d: "Drunk Panchonco blocks your path. Fight or negotiate!", s: "pow", e: 4, h: 8, a: ['stone','crowd', 'sky']},
    {t: "Barrel Lift Challenge", d: "Impress a dwarf by lifting his heaviest beer barrel!", s: "pow", e: 3, h: 6, a: ['stone','undead']},
    {t: "Dragon Lullaby", d: "Sing the drunken dragon to sleep before it burns the village!", s: "cha", e: 5, h: 9, a: ['crowd','pub']},
    {t: "Bard's Duel", d: "Outperform the traveling bard in a song contest!", s: "cha", e: 4, h: 7, a: ['pub','dark','undead']},
    {t: "King Antony's Trust", d: "Earn the king Antony's trust with your words!", s: "cha", e: 4, h: 7, a: ['pub','crowd']},
    {t: "Poison Antidote", d: "Something in my beer! Mix the correct herbs to save yourself!", s: "brn", e: 4, h: 8, a: ['magic','silent']},
    {t: "King's Antony Riddle", d: "Answer king Antony's three riddles or get excluded from Pavel's pub!", s: "brn", e: 4, h: 7, a: ['tech','magic','silent']},
    {t: "Nightmare Realm", d: "Trapped in a dream curse of nightmares. Will yourself awake!", s: "wil", e: 6, h: 10, a: ['dark','magic']}
];

// Group Missions - Everyone must work together!
const GROUP_STAGES = [
    // POW
    {t: "The Great Swamp Flood", d: "Pavel is sinking! Everyone bail water.", s: "pow", e: 10, h: 15, isGroup: true},
    {t: "Ork Horde Stand", d: "Push back the charging ork vanguard together!", s: "pow", e: 12, h: 16, isGroup: true},
    {t: "The Giant's Rock", d: "A mountain giant blocks the path. Pull it away.", s: "pow", e: 10, h: 18, isGroup: true},
    // SPD
    {t: "Dragon's Siege", d: "Dodge the falling fireballs from the drunken dragon!", s: "spd", e: 12, h: 17, isGroup: true},
    {t: "Village Fire Brigade", d: "The pub is on fire! Pass water bags at high speed.", s: "spd", e: 8, h: 13, isGroup: true},
    // BRN
    {t: "Lost Children Hunt", d: "Navigate the shifting mists using pure logic.", s: "brn", e: 10, h: 15, isGroup: true},
    {t: "Magic Barrier Repair", d: "Recalibrate the village shield. Focus!", s: "brn", e: 9, h: 14, isGroup: true},
    // CHA
    {t: "Monastic Choir", d: "Sing in perfect harmony to enter the holy city.", s: "cha", e: 7, h: 12, isGroup: true},
    {t: "The Final Toast", d: "Lead the tavern in the most epic song ever heard.", s: "cha", e: 7, h: 12, isGroup: true},
    // WIL
    {t: "The King's Banquet", d: "Resist the urge to drink all 5000 beers!", s: "wil", e: 8, h: 13, isGroup: true},
    {t: "Nick Stories", d: "Stand your ground with old geezer Nick so he doesn't tell you another story", s: "wil", e: 8, h: 13, isGroup: true}
];

// Combine group missions into main deck
STAGES.push(...GROUP_STAGES);

const HEROES = [
    { n: 'Dark Stalker', i: './images/dark.png', a: 'dark', s: {pow:5, spd:5, brn:5, cha:5, wil:5}, passive: 'Shadow Control', passiveDesc: 'Force a player to meditate. Uses: 2p=1, 3p=2, 4+p=3' },
    { n: 'Friendly AI', i: './images/ai.png', a: 'tech', s: {pow:6, spd:5, brn:6, cha:2, wil:6}, passive: 'System Override', passiveDesc: 'Use a different attribute. Recharges on friend challenge win' },
    { n: 'Thug Dwarf', i: './images/swag.png', a: 'stone', s: {pow:7, spd:2, brn:2, cha:5, wil:6}, passive: 'Brute Force', passiveDesc: 'Every time you win a challenge, gain +3 to POW' },
    { n: 'Babbler Rogue', i: './images/rogue.png', a: 'crowd', s: {pow:2, spd:4, brn:5, cha:8, wil:6}, passive: 'Crowd Favorite', passiveDesc: 'Gain +1 Glory for every 3 challenges you complete' },
    { n: 'Neighbor Witch', i: './images/magic.png', a: 'magic', s: {pow:2, spd:3, brn:8, cha:4, wil:7}, passive: 'Arcane Alliance', passiveDesc: 'Steal 1-3 stat points permanently from any player. Recharges after 3 wins.' },
    { n: 'Fancy Ninja', i: './images/ninja.png', a: 'shadow', s: {pow:4, spd:7, brn:5, cha:3, wil:5}, passive: 'Assassination Contract', passiveDesc: 'Bet on another player failing. If they fail, steal +1 stat. If they win, lose -1. Usable each turn.' },
    { n: 'Lost Dragon', i: './images/dragon.png', a: 'sky', s: {pow:8, spd:5, brn:4, cha:3, wil:3}, passive: 'Dragon Rage', passiveDesc: 'When spending 4+ on any stat, gain +3 bonus' },
    { n: 'Drunken Paladin', i: './images/paladin.png', a: 'pub', s: {pow:3, spd:2, brn:3, cha:8, wil:7}, passive: 'Liquid Courage', passiveDesc: 'Once per turn, roll dice. If 5 or 6, auto-win' },
    { n: 'Mute Monk', i: './images/monk.png', a: 'silent', s: {pow:3, spd:3, brn:9, cha:6, wil:7}, passive: 'Inner Peace', passiveDesc: 'Meditating restores +4 to one attribute of your choice' },
    { n: 'Lover Zombie', i: './images/zombie.png', a: 'undead', s: {pow:9, spd:2, brn:4, cha:3, wil:8}, passive: 'Cursed Embrace', passiveDesc: 'On victory: All players lose 2 from a stat, you gain +1' }
];

// ============================================================
// GAME STATE VARIABLES
// ============================================================

let party = [];           // Array of player objects
let deck = [];            // Shuffled challenges for this game
let round = 0;            // Current round (0 to totalRounds-1)
let totalRounds = 0;      // Total missions in the game
let pCount = 2;           // Number of players
let regIdx = 0;           // Registration index

// NEW TURN STRUCTURE VARIABLES
let readerIdx = 0;        // Who is the READER (opens & sets difficulty)
let activeIdx = 0;        // Who is currently ATTEMPTING the mission
let firstChallengerIdx = 0; // First challenger (left of reader) - becomes next reader
let originalFirstReaderIdx = 0; // Track who was the FIRST reader ever (for round tracking)
let stageInRound = 1;     // Track which stage within the current round

let pTarget = 0;          // Current challenge target number
let pPts = 0;             // Glory points for current challenge
let pStage = null;        // Current challenge object

let usedHeroes = [];      // Track which heroes have been selected
let passiveUsed = {};     // Track one-time passive usage
let challengesCompleted = {}; // Track for Crowd Favorite
let witchWins = {};       // Track Neighbor Witch wins
let shadowControlUses = {}; // Track Dark Stalker uses
let witchBorrowedStats = null; // Track borrowed stats from Witch
let ninjaContract = null; // Track Ninja's assassination contract

// Shop system
let nextShopRound = -1;
let shopCount = 0;
let storePlayerIdx = 0;
let storePoints = 5;
let tempStats = {};

let isProcessing = false; // Prevent race conditions

// ============================================================
// UTILITY FUNCTIONS
// ============================================================

function showBookSelect() {
    document.getElementById('intro-book-select').style.display = 'block';
    document.getElementById('intro-book-1').style.display = 'none';
    document.getElementById('intro-book-2').style.display = 'none';
    document.getElementById('intro-book-3').style.display = 'none';
    document.getElementById('intro-book-4').style.display = 'none';
}

function showBook(bookNum) {
    document.getElementById('intro-book-select').style.display = 'none';
    document.getElementById('intro-book-1').style.display = bookNum === 1 ? 'block' : 'none';
    document.getElementById('intro-book-2').style.display = bookNum === 2 ? 'block' : 'none';
    document.getElementById('intro-book-3').style.display = bookNum === 3 ? 'block' : 'none';
    document.getElementById('intro-book-4').style.display = bookNum === 4 ? 'block' : 'none';
}

function showModal(t, d, c) { 
    document.getElementById('modal').innerHTML = `<h2 class="medieval" style="margin-top:0;">${t}</h2><p style="font-size:16px; font-style:italic;">${d}</p><div style="margin-top:20px">${c}</div>`; 
    document.getElementById('overlay').style.display = 'flex'; 
    
    const buttons = document.querySelectorAll('.btn');
    buttons.forEach(btn => btn.style.pointerEvents = 'none');
    setTimeout(() => buttons.forEach(btn => btn.style.pointerEvents = 'auto'), 300);
}

function closeModal() { 
    document.getElementById('overlay').style.display = 'none'; 
}

function renderDice(number) {
    const positions = {
        1: [[42, 42]],
        2: [[22, 22], [68, 68]],
        3: [[22, 22], [42, 42], [68, 68]],
        4: [[22, 22], [68, 22], [22, 68], [68, 68]],
        5: [[22, 22], [68, 22], [42, 42], [22, 68], [68, 68]],
        6: [[22, 22], [68, 22], [22, 42], [68, 42], [22, 68], [68, 68]]
    };
    let dots = positions[number].map(([left, top]) => 
        `<div class="dice-dot" style="left: ${left}px; top: ${top}px;"></div>`
    ).join('');
    return `<div class="dice">${dots}</div>`;
}

// ============================================================
// SETUP & REGISTRATION
// ============================================================

function showSetup() {
    document.getElementById('view-intro').style.display = 'none';
    document.getElementById('view-setup').style.display = 'block';
}

function startReg() { 
    pCount = parseInt(document.getElementById('p-count-in').value); 
    usedHeroes = [];
    document.getElementById('view-setup').style.display = 'none'; 
    document.getElementById('view-reg').style.display = 'block'; 
}

function handleReg() {
    const name = document.getElementById('p-name-in').value || `Hero ${regIdx+1}`;
    const availableHeroes = HEROES.filter((h, idx) => !usedHeroes.includes(idx));
    
    if (availableHeroes.length === 0) {
        alert('All heroes have been selected!');
        return;
    }
    
    const randomIndex = Math.floor(Math.random() * availableHeroes.length);
    const hero = availableHeroes[randomIndex];
    const originalIndex = HEROES.indexOf(hero);
    usedHeroes.push(originalIndex);
    
    party.push({ pName: name, ...hero, cur: {...hero.s}, score: 0, skips: 3 });
    
    passiveUsed[regIdx] = false;
    challengesCompleted[regIdx] = 0;
    witchWins[regIdx] = 0;

    showModal(
        `Soul Linked`, 
        `${name}: ${hero.n}`, 
        `<div style="margin: 20px 0;">
            <img src="${hero.i}" alt="${hero.n}" style="width: 150px; height: 150px; border: 5px solid var(--gold); background: #000; box-shadow: 0 0 20px rgba(0,0,0,0.5);">
         </div>
         <button class="btn btn-main" onclick="closeModalAndNextReg()">Enter the Ledger</button>`
    );
}

function closeModalAndNextReg() {
    closeModal(); 
    regIdx++;
    if(regIdx < pCount) { 
        document.getElementById('p-name-in').value = ""; 
        document.getElementById('reg-subtitle').innerText = `ADVENTURER ${regIdx+1}`; 
    } else { 
        document.getElementById('view-reg').style.display = 'none'; 
        document.getElementById('view-deck').style.display = 'block'; 
    }
}

// ============================================================
// GAME START
// ============================================================

function startGame() {
    round = 0;
    stageInRound = 1;
    nextShopRound = -1;
    shopCount = 0;
    
    // Initialize pending state variables
    pendingReaderIdx = 0;
    pendingFirstChallengerIdx = 0;
    pendingRound = 0;
    pendingStageInRound = 1;
    
    totalRounds = parseInt(document.getElementById('deck-size-in').value);
    
    // Filter out group missions if only 2 players
    let masterPool = [...STAGES];
    if(party.length === 2) {
        masterPool = masterPool.filter(s => !s.isGroup);
        console.log('2 players: Group missions disabled');
    }
    
    deck = masterPool.sort(() => 0.5 - Math.random()).slice(0, totalRounds);
    
    // Initialize turn structure
    readerIdx = 0;                              // Player 0 is first reader
    originalFirstReaderIdx = 0;                 // Remember who started as first reader
    firstChallengerIdx = 1 % party.length;      // Player to the left of reader
    activeIdx = firstChallengerIdx;             // First challenger starts
    
    document.getElementById('view-deck').style.display = 'none'; 
    document.getElementById('view-game').style.display = 'block';
    
    updatePartyUI(); 
    updateTurnLabels();
    
    console.log(`ðŸŽ® GAME STARTED: ${party.length} players, ${totalRounds} rounds`);
    console.log(`ðŸ“œ Reader: ${party[readerIdx].pName}, First Challenger: ${party[firstChallengerIdx].pName}`);
}

function updateTurnLabels() {
    const reader = party[readerIdx];
    const challenger = party[activeIdx];
    
    document.getElementById('turn-label').innerText = 
        `ðŸ“œ READER: ${reader.pName.toUpperCase()} | âš”ï¸ CHALLENGER: ${challenger.pName.toUpperCase()}`;
    
    updateCounters();
}

function updateCounters() {
    const roundDisplay = document.getElementById('round-counter');
    if (roundDisplay) {
        // Show "Round X - Stage Y" format
        roundDisplay.innerText = `R${round + 1} Stage ${stageInRound}`;
    }
    
    const shopCountdownNumber = document.getElementById('shop-countdown-number');
    if (shopCountdownNumber) {
        // Calculate total stages completed
        const totalStagesCompleted = (round * party.length) + (stageInRound - 1);
        
        if (nextShopRound === -1) {
            const firstShopStage = party.length + 3;
            const stagesUntil = firstShopStage - totalStagesCompleted;
            shopCountdownNumber.innerText = stagesUntil > 0 ? stagesUntil : 'NOW';
            shopCountdownNumber.style.color = stagesUntil <= 2 ? '#ff9800' : 'var(--gold)';
        } else {
            const stagesUntilShop = nextShopRound - totalStagesCompleted;
            if (stagesUntilShop <= 0) {
                shopCountdownNumber.innerText = 'NOW';
                shopCountdownNumber.style.color = '#2ecc71';
            } else {
                shopCountdownNumber.innerText = stagesUntilShop;
                shopCountdownNumber.style.color = stagesUntilShop <= 2 ? '#ff9800' : 'var(--gold)';
            }
        }
    }
}

// ============================================================
// NEW TURN STRUCTURE: READER OPENS MISSION
// ============================================================

function readerOpensMission() {
    if (isProcessing) return;
    isProcessing = true;
    
    // Calculate deck index based on total missions played (round * party.length + stageInRound - 1)
    const deckIndex = (round * party.length) + stageInRound - 1;
    
    // Check if deck is exhausted
    if (deckIndex >= deck.length) {
        isProcessing = false;
        endGame();
        return;
    }
    
    pStage = deck[deckIndex];
    const reader = party[readerIdx];
    
    // Check if this is a group mission with only 2 players (shouldn't happen but safety)
    if(pStage.isGroup && party.length === 2) {
        // Draw another card
        deck[deckIndex] = deck.filter(s => !s.isGroup).sort(() => 0.5 - Math.random())[0];
        pStage = deck[deckIndex];
    }
    
    setTimeout(() => {
        isProcessing = false;
        
        // Show the mission and roll dice for difficulty
        showModal(
            `ðŸ“œ ${reader.pName} Reads the Mission`,
            `Roll the Fate Dice to determine difficulty!`,
            `<div style="margin: 15px 0;">
                <img src="${reader.i}" style="width: 80px; height: 80px; border: 3px solid var(--gold); background: #000;">
            </div>
            <div style="background: rgba(0,0,0,0.2); padding: 15px; margin: 15px 0; border: 2px solid var(--gold);">
                <h3 style="color: var(--gold); margin: 0 0 10px 0;">${pStage.isGroup ? 'ðŸ¤ GROUP: ' : ''}${pStage.t}</h3>
                <p style="font-size: 13px; font-style: italic;">"${pStage.d}"</p>
                <p style="margin-top: 10px;">Required: <b style="color: var(--blood);">${pStage.s.toUpperCase()}</b></p>
            </div>
            <div style="background: rgba(139,0,0,0.15); padding: 10px; border: 1px solid var(--blood); font-size: 12px; margin-bottom: 15px;">
                <p>ðŸŽ² <b>1-2-3</b> = Minor Encounter (${pStage.isGroup ? '+2' : '1'} Glory)</p>
                <p>ðŸŽ² <b>4-5-6</b> = Deadly Trial (${pStage.isGroup ? '+4' : '2'} Glory)</p>
            </div>
            <button class="btn btn-main" onclick="rollDifficultyDice(${pStage.isGroup})">ðŸŽ² Roll Fate Dice</button>`
        );
    }, 100);
}

function rollDifficultyDice(isGroup) {
    // Prevent double-clicking
    if(isProcessing) return;
    isProcessing = true;
    
    showModal("ðŸŽ² Rolling Fate Dice...", "The gods decide!", `<div id="fate-dice-container" style="margin: 30px 0;"></div>`);
    
    let rollCount = 0;
    const rollInterval = setInterval(() => {
        const randomNum = Math.floor(Math.random() * 6) + 1;
        document.getElementById('fate-dice-container').innerHTML = renderDice(randomNum);
        rollCount++;
        if(rollCount >= 10) clearInterval(rollInterval);
    }, 100);
    
    setTimeout(() => {
        clearInterval(rollInterval);
        const diceResult = Math.floor(Math.random() * 6) + 1;
        document.getElementById('fate-dice-container').innerHTML = renderDice(diceResult);
        
        setTimeout(() => {
            isProcessing = false;
            
            // Determine difficulty based on dice
            const isEasy = diceResult <= 3;
            const difficultyKey = isEasy ? 'e' : 'h';
            const gloryPts = isEasy ? 1 : 2;
            const difficultyName = isEasy ? 'Minor Encounter' : 'Deadly Trial';
            const target = pStage[difficultyKey];
            
            const reader = party[readerIdx];
            
            showModal(
                `ðŸŽ² Fate Has Spoken!`,
                `Rolled: ${diceResult}`,
                `<div style="background: ${isEasy ? 'rgba(27,94,32,0.2)' : 'rgba(139,0,0,0.2)'}; padding: 15px; border: 2px solid ${isEasy ? '#4caf50' : 'var(--blood)'}; margin: 15px 0;">
                    <h3 style="color: ${isEasy ? '#4caf50' : 'var(--blood)'}; margin: 0;">${difficultyName}</h3>
                    <p style="font-size: 20px; margin: 10px 0;"><b>Target: ${target} ${pStage.s.toUpperCase()}</b></p>
                    <p>Glory: <b style="color: var(--gold);">${isGroup ? (gloryPts * 2) + ' each' : gloryPts}</b></p>
                </div>
                ${isGroup ? `<p style="font-size: 12px; color: var(--blood);">âš ï¸ ${reader.pName} cannot participate!</p>` : ''}
                <p style="font-size: 12px; color: #888;">Only ${reader.pName} knows the target!</p>
                <button class="btn btn-main" onclick="readerSetsDifficulty('${difficultyKey}', ${gloryPts}, ${isGroup})">Continue</button>`
            );
        }, 500);
    }, 1200);
}

function readerSetsDifficulty(m, pts, isGroup) {
    if(isGroup) {
        readerSetsDifficultyGroup(m, pts);
        return;
    }
    
    pTarget = pStage[m];
    pPts = pts;
    
    // Set the active player to the first challenger (left of reader)
    activeIdx = firstChallengerIdx;
    
    // Display challenge info WITHOUT showing the target (it's secret!)
    document.getElementById('st-title').innerText = pStage.t;
    document.getElementById('st-desc').innerText = pStage.d;
    document.getElementById('st-req').innerText = `REQUIRED: ${pStage.s.toUpperCase()} | DIFFICULTY: ???`;
    
    document.getElementById('draw-btn').style.display = 'none';
    document.getElementById('game-controls').style.display = 'block';
    
    closeModal();
    updatePartyUI();
    updateTurnLabels();
    
    // Show who's turn it is - but DON'T reveal target!
    const challenger = party[activeIdx];
    const reader = party[readerIdx];
    showModal(
        `${challenger.pName}'s Turn`,
        `You must face the challenge!`,
        `<div style="margin: 15px 0;">
            <img src="${challenger.i}" style="width: 80px; height: 80px; border: 3px solid var(--gold); background: #000;">
        </div>
        <p>Challenge: <b>${pStage.t}</b></p>
        <p>Required Stat: <b style="color: var(--gold);">${pStage.s.toUpperCase()}</b></p>
        <div style="background: rgba(139,0,0,0.2); padding: 10px; margin: 15px 0; border: 1px solid var(--blood);">
            <p style="color: var(--blood); font-weight: bold;">âš ï¸ DIFFICULTY IS SECRET!</p>
            <p style="font-size: 12px;">${reader.pName} saw the dice roll, but you didn't!</p>
        </div>
        <button class="btn btn-main" onclick="closeModal()">Face the Challenge</button>`
    );
}

// ============================================================
// CHALLENGE ATTEMPT
// ============================================================

function startFight() {
    // Check if current player is the reader (shouldn't be able to attempt)
    if(activeIdx === readerIdx) {
        alert("The Reader cannot attempt the mission!");
        return;
    }
    
    const h = party[activeIdx];
    
    // Build passive options - can show multiple
    let passiveButtons = [];
    
    // Drunken Paladin - Liquid Courage
    if(h.n === 'Drunken Paladin' && !h.paladinDiceUsedThisTurn) {
        passiveButtons.push(`<button class="btn btn-main" style="background:#2b1010; border-color:#8b0000; margin-top:8px; width:100%;" onclick="rollPaladinDice()">ðŸŽ² Liquid Courage (Roll 5-6 = Auto-win)</button>`);
    }
    
    // Friendly AI - System Override
    if(h.n === 'Friendly AI' && !passiveUsed[activeIdx]) {
        passiveButtons.push(`<button class="btn btn-main" style="background:#2b1010; border-color:#8b0000; margin-top:8px; width:100%;" onclick="useSystemOverride()">âš¡ System Override (Use Different Stat)</button>`);
    }
    
    // Neighbor Witch - Arcane Alliance
    if(h.n === 'Neighbor Witch' && !passiveUsed[activeIdx] && party.length > 1) {
        passiveButtons.push(`<button class="btn btn-main" style="background:#2b1010; border-color:#8b0000; margin-top:8px; width:100%;" onclick="useArcaneAlliance()">ðŸ”® Arcane Alliance (Steal Stats)</button>`);
    }
    
    // Dark Stalker - Shadow Control
    if(h.n === 'Dark Stalker' && canUseShadowControl(activeIdx)) {
        passiveButtons.push(`<button class="btn btn-main" style="background:#2b1010; border-color:#8b0000; margin-top:8px; width:100%;" onclick="useShadowControl()">ðŸ—¡ï¸ Shadow Control (Force Meditation)</button>`);
    }
    
    // Fancy Ninja - Assassination Contract
    if(h.n === 'Fancy Ninja' && canUseAssassinationContract(activeIdx)) {
        passiveButtons.push(`<button class="btn btn-main" style="background:#2b1010; border-color:#8b0000; margin-top:8px; width:100%;" onclick="setupAssassinationContract()">ðŸ¥· Assassination Contract (Bet on Failure)</button>`);
    }
    
    let passiveOptions = passiveButtons.length > 0 
        ? `<div style="margin-top: 15px; border-top: 1px solid #8e7b55; padding-top: 10px;"><p style="font-size: 11px; color: #888; margin-bottom: 5px;">SPECIAL ABILITIES:</p>${passiveButtons.join('')}</div>` 
        : '';
    
    // Check for Dragon Rage hint
    let dragonHint = '';
    if(h.n === 'Lost Dragon') {
        dragonHint = `<p style="font-size: 11px; color: var(--blood); margin-top: 8px;">ðŸ‰ Dragon Rage: Spend 4+ for +3 bonus!</p>`;
    }
    
    // Show stolen stats if Witch used ability
    let borrowedInfo = '';
    if(witchBorrowedStats && witchBorrowedStats.borrower === activeIdx) {
        borrowedInfo = `<p style="font-size: 11px; color: var(--gold); margin-top: 5px;">ðŸ”® Stole +${witchBorrowedStats.amount} ${witchBorrowedStats.stat.toUpperCase()} from ${party[witchBorrowedStats.lender].pName}</p>`;
    }
    
    // Show ninja contract if active
    let ninjaInfo = '';
    if(ninjaContract && ninjaContract.target === activeIdx) {
        ninjaInfo = `<p style="font-size: 11px; color: var(--blood); margin-top: 5px;">ðŸ¥· ${party[ninjaContract.ninja].pName} has a contract on you!</p>`;
    }
    
    showModal(`${h.pName}'s Attempt`, `Hero: ${h.n}`, `
        <div style="margin: 15px 0;">
            <img src="${h.i}" alt="${h.n}" style="width: 80px; height: 80px; border: 3px solid var(--gold); background: #000; border-radius: 5px;">
        </div>
        <p>Required: <b style="color: var(--blood);">${pStage.s.toUpperCase()}</b> | Target: <b style="color: var(--blood);">???</b></p>
        <p>Your ${pStage.s.toUpperCase()}: <b style="color: var(--gold);">${h.cur[pStage.s]}</b></p>
        ${dragonHint}
        ${borrowedInfo}
        ${ninjaInfo}
        <p style="margin-top: 15px;">How many points will you spend?</p>
        <input type="number" id="amt" value="1" min="0" max="${h.cur[pStage.s]}" class="input-hero" style="width:80px; text-align:center; font-size: 24px; margin: 10px 0;">
        <div id="error-msg" style="color:var(--blood); font-size:13px; margin-top:5px; display:none; font-weight:bold;">Not enough points!</div>
        <button class="btn btn-main" style="margin-top:20px;" onclick="processAttempt()">Attempt!</button>
        ${passiveOptions}
    `);
}

function processAttempt() {
    const h = party[activeIdx];
    let spend = parseInt(document.getElementById('amt').value) || 0;
    
    if (spend > h.cur[pStage.s]) {
        document.getElementById('error-msg').style.display = 'block';
        return;
    }
    
    // Calculate bonuses
    let affinityBonus = (Array.isArray(pStage.a) ? pStage.a.includes(h.a) : h.a === pStage.a) ? 3 : 0;
    
    // Lost Dragon passive
    let dragonBonus = 0;
    if(h.n === 'Lost Dragon' && spend >= 4) {
        dragonBonus = 3;
    }
    
    let total = spend + affinityBonus + dragonBonus;
    h.cur[pStage.s] -= spend;
    
    let win = total >= pTarget;
    
    showResult(spend, affinityBonus + dragonBonus, total, win, pStage.s);
}

function showResult(spent, bonus, final, win, usedStat) {
    const h = party[activeIdx];
    
    let bonusLine = bonus > 0 ? `<p style="color:#8b0000; font-weight:900;">âœ¨ BONUS: +${bonus}</p>` : '';
    
    if(!win && final < pTarget) {
        // Failed - offer gamble option
        showModal(
            `Attempt Failed!`,
            `Power: ${final} / Target: ${pTarget}`,
            `${bonusLine}
            <p style="margin: 15px 0;">You fell short! Gamble for +1 to +6?</p>
            <button class="btn btn-main" style="background:var(--blood); color:white; border-color:white;" onclick="gamble(${final}, '${usedStat}')">ðŸŽ² Gamble!</button>
            <button class="btn btn-skip" onclick="challengeFailed()">Accept Failure</button>`
        );
    } else if(win) {
        // Success!
        h.score += pPts;
        h.cur[usedStat] += 2; // Recover 2 points
        
        // Track challenge completion
        challengesCompleted[activeIdx]++;
        
        // Passive triggers
        let passiveTriggers = '';
        
        // Thug Dwarf
        if(h.n === 'Thug Dwarf') {
            h.cur.pow += 3;
            passiveTriggers += `<p style="color:#f3cf7a; font-size:12px;">âš¡ Brute Force: +3 POW!</p>`;
        }
        
        // Babbler Rogue
        if(h.n === 'Babbler Rogue' && challengesCompleted[activeIdx] % 3 === 0) {
            h.score += 1;
            passiveTriggers += `<p style="color:#f3cf7a; font-size:12px;">âš¡ Crowd Favorite: +1 Glory!</p>`;
        }
        
        // Neighbor Witch recharge
        if(h.n === 'Neighbor Witch') {
            witchWins[activeIdx] = (witchWins[activeIdx] || 0) + 1;
            if(witchWins[activeIdx] >= 3 && passiveUsed[activeIdx]) {
                passiveUsed[activeIdx] = false;
                witchWins[activeIdx] = 0;
                passiveTriggers += `<p style="color:#f3cf7a; font-size:12px;">âš¡ Arcane Alliance Recharged!</p>`;
            }
        }
        
        // Check for Lover Zombie
        if(h.n === 'Lover Zombie') {
            updatePartyUI();
            selectLoverZombieDebuff();
            return;
        }
        
        showModal(
            `<span class="result-success">ðŸ† VICTORY!</span>`,
            `${h.pName} conquers the challenge!`,
            `<div style="display:flex; justify-content:space-around; margin:20px 0;">
                <div><b style="font-size:24px; color:var(--gold);">${final}</b><br><small>Your Power</small></div>
                <div style="opacity:0.3; font-size:24px;">VS</div>
                <div><b style="font-size:24px; color:var(--blood);">${pTarget}</b><br><small>Target</small></div>
            </div>
            ${bonusLine}
            <p style="color:#1b5e20; font-weight:bold;">+${pPts} Glory! +2 ${usedStat.toUpperCase()} recovered!</p>
            ${passiveTriggers}
            <button class="btn btn-main" onclick="challengeWon()">Continue</button>`
        );
        updatePartyUI();
    }
}

function gamble(cur, usedStat) {
    showModal("ðŸŽ² Rolling the Bones...", "Fate decides!", `<div id="dice-container" style="margin: 30px 0;"></div>`);
    
    let rollCount = 0;
    const rollInterval = setInterval(() => {
        const randomNum = Math.floor(Math.random() * 6) + 1;
        document.getElementById('dice-container').innerHTML = renderDice(randomNum);
        rollCount++;
        if(rollCount >= 8) clearInterval(rollInterval);
    }, 100);
    
    setTimeout(() => {
        clearInterval(rollInterval);
        const luck = Math.floor(Math.random() * 6) + 1;
        document.getElementById('dice-container').innerHTML = renderDice(luck);
        
        setTimeout(() => {
            const h = party[activeIdx];
            let fin = cur + luck;
            let win = fin >= pTarget;
            
            if(win) { 
                h.score += pPts;
                h.cur[usedStat] += 2;
                challengesCompleted[activeIdx]++;
                
                let passiveTriggers = '';
                if(h.n === 'Thug Dwarf') {
                    h.cur.pow += 3;
                    passiveTriggers += `<p style="color:#f3cf7a; font-size:12px;">âš¡ Brute Force: +3 POW!</p>`;
                }
                if(h.n === 'Babbler Rogue' && challengesCompleted[activeIdx] % 3 === 0) {
                    h.score += 1;
                    passiveTriggers += `<p style="color:#f3cf7a; font-size:12px;">âš¡ Crowd Favorite: +1 Glory!</p>`;
                }
                
                // Neighbor Witch recharge
                if(h.n === 'Neighbor Witch') {
                    witchWins[activeIdx] = (witchWins[activeIdx] || 0) + 1;
                    if(witchWins[activeIdx] >= 3 && passiveUsed[activeIdx]) {
                        passiveUsed[activeIdx] = false;
                        witchWins[activeIdx] = 0;
                        passiveTriggers += `<p style="color:#f3cf7a; font-size:12px;">âš¡ Arcane Alliance Recharged!</p>`;
                    }
                }
                
                if(h.n === 'Lover Zombie') {
                    updatePartyUI();
                    selectLoverZombieDebuff();
                    return;
                }
                
                showModal(
                    `<span class="result-success">ðŸŽ² MIRACULOUS VICTORY!</span>`,
                    `Rolled a ${luck}!`,
                    `<p>Final Power: <b>${fin}</b> vs Target: <b>${pTarget}</b></p>
                    <p style="color:#1b5e20; font-weight:bold;">+${pPts} Glory!</p>
                    ${passiveTriggers}
                    <button class="btn btn-main" onclick="challengeWon()">Continue</button>`
                );
            } else {
                showModal(
                    `<span class="result-failure">ðŸ’€ TOTAL FAILURE</span>`,
                    `Rolled a ${luck}`,
                    `<p>Final Power: <b>${fin}</b> vs Target: <b>${pTarget}</b></p>
                    <p style="color:var(--blood);">Not enough...</p>
                    <button class="btn btn-main" onclick="challengeFailed()">Continue</button>`
                );
            }
            updatePartyUI();
        }, 500);
    }, 900);
}

// ============================================================
// CHALLENGE RESULTS - NEW ROTATION LOGIC
// ============================================================

function challengeWon() {
    // Resolve Ninja contract (target won, ninja loses)
    if(ninjaContract && ninjaContract.target === activeIdx) {
        const ninja = party[ninjaContract.ninja];
        const stat = ninjaContract.stat;
        ninja.cur[stat] = Math.max(0, ninja.cur[stat] - 1);
        ninjaContract = null;
        updatePartyUI();
    }
    
    // Return borrowed stats from Witch
    returnBorrowedStats();
    
    // Challenge was won - advance to next round
    closeModal();
    advanceToNextRound();
}

function challengeFailed() {
    // Check if ninja had a contract on THIS player who just failed
    if(ninjaContract && ninjaContract.target === activeIdx) {
        const ninja = party[ninjaContract.ninja];
        const target = party[ninjaContract.target];
        const stat = ninjaContract.stat;
        // Target failed, ninja steals
        target.cur[stat] = Math.max(0, target.cur[stat] - 1);
        ninja.cur[stat] += 1;
        ninjaContract = null;
        updatePartyUI();
    }
    
    // Return borrowed stats from Witch
    returnBorrowedStats();
    
    // Current challenger failed - move to next player clockwise
    closeModal();
    
    let nextChallenger = (activeIdx + 1) % party.length;
    
    // Check if we've come back to the reader (full rotation, everyone failed)
    if(nextChallenger === readerIdx) {
        // Clear any remaining ninja contract (shouldn't happen but just in case)
        ninjaContract = null;
        
        // Everyone failed! Mission discarded.
        showModal(
            `ðŸ’€ Mission Discarded!`,
            `All challengers have failed!`,
            `<p style="margin: 20px 0;">The mission "${pStage.t}" proved too difficult.</p>
            <p style="font-size: 14px; color: #888;">No glory was earned this round.</p>
            <button class="btn btn-main" onclick="missionDiscarded()">Next Mission</button>`
        );
    } else {
        // Move to next challenger
        activeIdx = nextChallenger;
        updatePartyUI();
        updateTurnLabels();
        
        const nextPlayer = party[activeIdx];
        const reader = party[readerIdx];
        showModal(
            `${nextPlayer.pName}'s Turn`,
            `Previous challenger failed! You're up!`,
            `<div style="margin: 15px 0;">
                <img src="${nextPlayer.i}" style="width: 80px; height: 80px; border: 3px solid var(--gold); background: #000;">
            </div>
            <p>Challenge: <b>${pStage.t}</b></p>
            <p>Required: <b style="color: var(--gold);">${pStage.s.toUpperCase()}</b> | Target: <b style="color: var(--blood);">???</b></p>
            <div style="background: rgba(139,0,0,0.2); padding: 8px; margin: 10px 0; border: 1px solid var(--blood); font-size: 12px;">
                <p style="color: var(--blood);">âš ï¸ ${reader.pName} knows the difficulty!</p>
            </div>
            <button class="btn btn-main" onclick="closeModal()">Face the Challenge</button>`
        );
    }
}

function missionDiscarded() {
    closeModal();
    // Clear any remaining ninja contract
    ninjaContract = null;
    advanceToNextRound();
}

function advanceToNextStage() {
    // Clear any active ninja contract for new stage
    ninjaContract = null;
    
    // Reset Drunken Paladin's dice for new stage (can use once per turn)
    party.forEach(p => {
        if(p.n === 'Drunken Paladin') {
            p.paladinDiceUsedThisTurn = false;
        }
    });
    
    // Calculate what the NEXT reader would be
    const nextReaderIdx = firstChallengerIdx;
    const nextFirstChallengerIdx = (nextReaderIdx + 1) % party.length;
    
    // Determine if this would be a new round (next reader = original first reader)
    let nextRound = round;
    let nextStageInRound = stageInRound + 1;
    if (nextReaderIdx === originalFirstReaderIdx) {
        nextRound = round + 1;
        nextStageInRound = 1;
    }
    
    // Calculate total stages that WILL BE completed after this advance
    const totalStagesCompleted = (nextRound * party.length) + nextStageInRound;
    
    // Calculate shop timing based on stages
    if (nextShopRound === -1) {
        nextShopRound = party.length + 3; // First shop after this many stages
    }
    
    // Check if shop time BEFORE advancing (shop happens between stages)
    if (totalStagesCompleted >= nextShopRound) {
        shopCount++;
        const base = party.length + 3;
        const multiplier = shopCount * 0.33;
        const nextInterval = Math.round(base + (base * multiplier));
        nextShopRound = totalStagesCompleted + nextInterval;
        
        // Store the pending state for after shop
        pendingReaderIdx = nextReaderIdx;
        pendingFirstChallengerIdx = nextFirstChallengerIdx;
        pendingRound = nextRound;
        pendingStageInRound = nextStageInRound;
        
        storePlayerIdx = 0;
        openStore();
        return;
    }
    
    // Check if game is over (based on deck being empty)
    if (totalStagesCompleted > totalRounds) {
        endGame();
        return;
    }
    
    // Now actually advance
    readerIdx = nextReaderIdx;
    firstChallengerIdx = nextFirstChallengerIdx;
    activeIdx = firstChallengerIdx;
    round = nextRound;
    stageInRound = nextStageInRound;
    
    if (nextReaderIdx === originalFirstReaderIdx && nextRound > 0) {
        console.log(`ðŸ”„ NEW ROUND ${round + 1}! Reader back to ${party[readerIdx].pName}`);
    }
    
    console.log(`ðŸ“œ Round ${round + 1}, Stage ${stageInRound}: Reader: ${party[readerIdx].pName}, First Challenger: ${party[firstChallengerIdx].pName}`);
    
    resetUI();
}

// Variables to store pending state during shop
let pendingReaderIdx = 0;
let pendingFirstChallengerIdx = 0;
let pendingRound = 0;
let pendingStageInRound = 1;

// Keep old name for compatibility
function advanceToNextRound() {
    advanceToNextStage();
}

function resetUI() {
    document.getElementById('draw-btn').style.display = 'block';
    document.getElementById('game-controls').style.display = 'none';
    document.getElementById('st-title').innerText = "A New Mission Awaits";
    document.getElementById('st-desc').innerText = "";
    document.getElementById('st-req').innerText = "";
    
    // Calculate progress based on total missions played
    const totalMissionsPlayed = (round * party.length) + stageInRound - 1;
    document.getElementById('prog-bar').style.width = `${(totalMissionsPlayed/totalRounds)*100}%`;
    
    updateTurnLabels();
    closeModal();
    updatePartyUI();
}

// ============================================================
// MEDITATION (PASS)
// ============================================================

function meditateTurn() {
    if(activeIdx === readerIdx) {
        alert("The Reader cannot meditate - they don't participate!");
        return;
    }
    
    const h = party[activeIdx];
    
    if(h.skips <= 0) {
        alert("No meditations remaining! You must attempt the challenge.");
        return;
    }
    
    h.skips--;
    
    // Mute Monk passive
    if(h.n === 'Mute Monk') {
        showModal("ðŸ§˜ Inner Peace", "Choose an attribute to restore +4", `
            <div style="margin: 15px 0;">
                <img src="${h.i}" style="width: 80px; height: 80px; border: 3px solid var(--gold); background: #000;">
            </div>
            <select id="monk-restore-stat" class="input-hero" style="width:100%; font-size:18px; padding:10px; margin:15px 0;">
                <option value="pow">POW (${h.cur.pow})</option>
                <option value="spd">SPD (${h.cur.spd})</option>
                <option value="brn">BRN (${h.cur.brn})</option>
                <option value="cha">CHA (${h.cur.cha})</option>
                <option value="wil">WIL (${h.cur.wil})</option>
            </select>
            <button class="btn btn-main" onclick="finishMonkMeditate()">Restore</button>
        `);
        return;
    }
    
    // Regular meditation - counts as failure, passes to next player
    updatePartyUI();
    challengeFailed();
}

function finishMonkMeditate() {
    const h = party[activeIdx];
    const chosenStat = document.getElementById('monk-restore-stat').value;
    h.cur[chosenStat] += 4;
    updatePartyUI();
    challengeFailed();
}

// ============================================================
// CHALLENGE A FRIEND - Only non-readers can initiate
// ============================================================

function initiateFriendChallenge() {
    if(activeIdx === readerIdx) {
        alert("The Reader cannot challenge a friend!");
        return;
    }
    
    // Get other players (excluding reader and current active)
    let eligibleOpponents = party.filter((p, i) => i !== activeIdx && i !== readerIdx);
    
    if(eligibleOpponents.length === 0) {
        alert("No eligible opponents available!");
        return;
    }
    
    let playerOptions = eligibleOpponents.map((p) => {
        let realIdx = party.indexOf(p);
        return `<option value="${realIdx}">${p.pName} (${p.n})</option>`;
    }).join('');
    
    showModal("Challenge a Friend", "Choose Your Opponent", `
        <p style="font-size:14px; margin-bottom:15px;">You gain +3 Courage Bonus for initiating!</p>
        <select id="challenge-opponent" class="input-hero" style="width:100%; font-size:18px; padding:10px; margin-bottom:20px;">
            ${playerOptions}
        </select>
        <button class="btn btn-main" onclick="startFriendChallenge()">Issue Challenge!</button>
        <button class="btn btn-skip" onclick="closeModal()">Cancel</button>
    `);
}

let friendChallengeData = null;

function startFriendChallenge() {
    let opponentIdx = parseInt(document.getElementById('challenge-opponent').value);
    
    // Reset all fields to prevent leftover data from previous challenges
    friendChallengeData = {
        challenger: activeIdx,
        opponent: opponentIdx,
        challengerSpend: 0,
        opponentSpend: 0,
        challengerOwnSpend: undefined,
        opponentOwnSpend: undefined,
        challengerOverrideStat: undefined,
        opponentOverrideStat: undefined,
        challengerBorrowAmt: undefined,
        opponentBorrowAmt: undefined,
        challengerBorrowFrom: undefined,
        opponentBorrowFrom: undefined,
        challengerAutoWin: false,
        opponentAutoWin: false
    };
    
    const challenger = party[activeIdx];
    const opponent = party[opponentIdx];
    
    showModal(
        `${challenger.pName} vs ${opponent.pName}!`,
        "The Duel Begins",
        `<div style="display:flex; justify-content:center; gap:30px; margin:20px 0;">
            <div style="text-align:center;">
                <img src="${challenger.i}" style="width: 60px; height: 60px; border: 3px solid var(--gold); background: #000;">
                <p style="font-size:12px; margin-top:5px;">${challenger.pName}<br><b>+3 Courage</b></p>
            </div>
            <div style="display:flex; align-items:center; font-size:30px; color:var(--blood);">VS</div>
            <div style="text-align:center;">
                <img src="${opponent.i}" style="width: 60px; height: 60px; border: 3px solid var(--gold); background: #000;">
                <p style="font-size:12px; margin-top:5px;">${opponent.pName}</p>
            </div>
        </div>
        <p>Required: <b>${pStage.s.toUpperCase()}</b> | Target: <b style="color:var(--blood);">???</b></p>
        <button class="btn btn-main" onclick="friendChallengerInvest()">Proceed</button>`
    );
}

function friendChallengerInvest() {
    const challenger = party[friendChallengeData.challenger];
    const challengerIdx = friendChallengeData.challenger;
    
    // Check for passives
    let canUseOverride = (challenger.n === 'Friendly AI' && !passiveUsed[challengerIdx]);
    let canUseArcaneAlliance = (challenger.n === 'Neighbor Witch' && !passiveUsed[challengerIdx]);
    let canUseLiquidCourage = (challenger.n === 'Drunken Paladin' && !passiveUsed[challengerIdx]);
    
    let passiveOptions = '';
    if(canUseOverride) {
        passiveOptions = `<button class="btn btn-main" style="background:#2b1010; border-color:#8b0000; margin-top:10px;" onclick="useFriendSystemOverride('challenger')">âš¡ System Override (Use Different Stat)</button>`;
    } else if(canUseArcaneAlliance) {
        passiveOptions = `<button class="btn btn-main" style="background:#2b1010; border-color:#8b0000; margin-top:10px;" onclick="useFriendArcaneAlliance('challenger')">âš¡ Arcane Alliance (Steal Points)</button>`;
    } else if(canUseLiquidCourage) {
        passiveOptions = `<button class="btn btn-main" style="background:#2b1010; border-color:#8b0000; margin-top:10px;" onclick="useFriendLiquidCourage('challenger')">ðŸº Liquid Courage (Roll for Auto-Win)</button>`;
    }
    
    // Dragon Rage note
    let dragonNote = '';
    if(challenger.n === 'Lost Dragon') {
        dragonNote = `<p style="font-size: 12px; color: #FF6347; margin-top: 8px;">âš¡ Dragon Rage: Spend 4+ for +3 bonus!</p>`;
    }
    
    showModal(
        `${challenger.pName}'s Investment`,
        "You have +3 Courage Bonus!",
        `<div style="margin: 15px 0;">
            <img src="${challenger.i}" style="width: 80px; height: 80px; border: 3px solid var(--gold); background: #000;">
        </div>
        <p>Your ${pStage.s.toUpperCase()}: <b>${challenger.cur[pStage.s]}</b></p>
        ${dragonNote}
        <input type="number" id="friend-amt-1" class="input-hero" value="0" min="0" max="${challenger.cur[pStage.s]}" style="width:100%; font-size:30px; text-align:center; margin:10px 0;">
        <button class="btn btn-main" onclick="setFriendChallengerBet()">Commit</button>
        ${passiveOptions}`
    );
}

function setFriendChallengerBet() {
    let spend = parseInt(document.getElementById('friend-amt-1').value) || 0;
    const challenger = party[friendChallengeData.challenger];
    
    if(spend > challenger.cur[pStage.s]) {
        alert("Not enough points!");
        return;
    }
    
    friendChallengeData.challengerSpend = spend;
    friendChallengeData.challengerOwnSpend = spend; // Track own spend for consistency
    friendOpponentInvest();
}

function friendOpponentInvest() {
    const opponent = party[friendChallengeData.opponent];
    const opponentIdx = friendChallengeData.opponent;
    
    // Check for passives
    let canUseOverride = (opponent.n === 'Friendly AI' && !passiveUsed[opponentIdx]);
    let canUseArcaneAlliance = (opponent.n === 'Neighbor Witch' && !passiveUsed[opponentIdx]);
    let canUseLiquidCourage = (opponent.n === 'Drunken Paladin' && !passiveUsed[opponentIdx]);
    
    let passiveOptions = '';
    if(canUseOverride) {
        passiveOptions = `<button class="btn btn-main" style="background:#2b1010; border-color:#8b0000; margin-top:10px;" onclick="useFriendSystemOverride('opponent')">âš¡ System Override (Use Different Stat)</button>`;
    } else if(canUseArcaneAlliance) {
        passiveOptions = `<button class="btn btn-main" style="background:#2b1010; border-color:#8b0000; margin-top:10px;" onclick="useFriendArcaneAlliance('opponent')">âš¡ Arcane Alliance (Steal Points)</button>`;
    } else if(canUseLiquidCourage) {
        passiveOptions = `<button class="btn btn-main" style="background:#2b1010; border-color:#8b0000; margin-top:10px;" onclick="useFriendLiquidCourage('opponent')">ðŸº Liquid Courage (Roll for Auto-Win)</button>`;
    }
    
    // Dragon Rage note
    let dragonNote = '';
    if(opponent.n === 'Lost Dragon') {
        dragonNote = `<p style="font-size: 12px; color: #FF6347; margin-top: 8px;">âš¡ Dragon Rage: Spend 4+ for +3 bonus!</p>`;
    }
    
    showModal(
        `${opponent.pName}'s Investment`,
        "How much will you risk?",
        `<div style="margin: 15px 0;">
            <img src="${opponent.i}" style="width: 80px; height: 80px; border: 3px solid var(--gold); background: #000;">
        </div>
        <p>Your ${pStage.s.toUpperCase()}: <b>${opponent.cur[pStage.s]}</b></p>
        ${dragonNote}
        <input type="number" id="friend-amt-2" class="input-hero" value="0" min="0" max="${opponent.cur[pStage.s]}" style="width:100%; font-size:30px; text-align:center; margin:10px 0;">
        <button class="btn btn-main" onclick="setFriendOpponentBet()">Commit</button>
        ${passiveOptions}`
    );
}

function setFriendOpponentBet() {
    let spend = parseInt(document.getElementById('friend-amt-2').value) || 0;
    const opponent = party[friendChallengeData.opponent];
    
    if(spend > opponent.cur[pStage.s]) {
        alert("Not enough points!");
        return;
    }
    
    friendChallengeData.opponentSpend = spend;
    friendChallengeData.opponentOwnSpend = spend; // Track own spend for consistency
    resolveFriendChallenge();
}

function resolveFriendChallenge() {
    const challenger = party[friendChallengeData.challenger];
    const opponent = party[friendChallengeData.opponent];
    
    // Handle stat overrides for deduction
    const challengerStat = friendChallengeData.challengerOverrideStat || pStage.s;
    const opponentStat = friendChallengeData.opponentOverrideStat || pStage.s;
    
    // Calculate own spend (accounts for borrowed points)
    const challengerOwnSpend = friendChallengeData.challengerOwnSpend !== undefined ? friendChallengeData.challengerOwnSpend : friendChallengeData.challengerSpend;
    const opponentOwnSpend = friendChallengeData.opponentOwnSpend !== undefined ? friendChallengeData.opponentOwnSpend : friendChallengeData.opponentSpend;
    
    // Deduct points from the correct stat
    challenger.cur[challengerStat] -= challengerOwnSpend;
    opponent.cur[opponentStat] -= opponentOwnSpend;
    
    // Calculate totals
    let challengerBonus = (Array.isArray(pStage.a) ? pStage.a.includes(challenger.a) : challenger.a === pStage.a) ? 3 : 0;
    let opponentBonus = (Array.isArray(pStage.a) ? pStage.a.includes(opponent.a) : opponent.a === pStage.a) ? 3 : 0;
    
    // Dragon Rage
    if(challenger.n === 'Lost Dragon' && friendChallengeData.challengerSpend >= 4) challengerBonus += 3;
    if(opponent.n === 'Lost Dragon' && friendChallengeData.opponentSpend >= 4) opponentBonus += 3;
    
    let challengerTotal = friendChallengeData.challengerSpend + challengerBonus + 3; // +3 Courage
    let opponentTotal = friendChallengeData.opponentSpend + opponentBonus;
    
    // Check for auto-wins (Liquid Courage)
    let challengerWin = friendChallengeData.challengerAutoWin || (challengerTotal >= pTarget);
    let opponentWin = friendChallengeData.opponentAutoWin || (opponentTotal >= pTarget);
    
    // Build info strings for passives used
    let challengerInfo = '';
    if(friendChallengeData.challengerAutoWin) {
        challengerInfo += `<p style="font-size:10px; color:#4caf50;">ðŸº LIQUID COURAGE AUTO-WIN!</p>`;
    }
    if(friendChallengeData.challengerOverrideStat) {
        challengerInfo += `<p style="font-size:10px; color:#9370DB;">âš¡ Used ${challengerStat.toUpperCase()}</p>`;
    }
    if(friendChallengeData.challengerBorrowAmt) {
        challengerInfo += `<p style="font-size:10px; color:#9370DB;">âš¡ Stole ${friendChallengeData.challengerBorrowAmt} from ${friendChallengeData.challengerBorrowFrom}</p>`;
    }
    
    let opponentInfo = '';
    if(friendChallengeData.opponentAutoWin) {
        opponentInfo += `<p style="font-size:10px; color:#4caf50;">ðŸº LIQUID COURAGE AUTO-WIN!</p>`;
    }
    if(friendChallengeData.opponentOverrideStat) {
        opponentInfo += `<p style="font-size:10px; color:#9370DB;">âš¡ Used ${opponentStat.toUpperCase()}</p>`;
    }
    if(friendChallengeData.opponentBorrowAmt) {
        opponentInfo += `<p style="font-size:10px; color:#9370DB;">âš¡ Stole ${friendChallengeData.opponentBorrowAmt} from ${friendChallengeData.opponentBorrowFrom}</p>`;
    }
    
    updatePartyUI();
    
    // Show results
    showModal(
        "Duel Results",
        "Who proved worthy?",
        `<div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin:20px 0;">
            <div style="border:2px solid var(--gold); padding:15px; border-radius:5px; background: rgba(197, 160, 89, 0.1);">
                <b>${challenger.pName}</b>
                <p style="font-size:12px;">Spent: ${friendChallengeData.challengerSpend}</p>
                ${challengerInfo}
                <p style="font-size:12px;">Courage: +3</p>
                <p style="font-size:12px;">Affinity: +${challengerBonus}</p>
                <p style="font-size:20px; color:var(--gold);"><b>${friendChallengeData.challengerAutoWin ? 'AUTO' : challengerTotal}</b></p>
                <p style="color:${challengerWin ? '#2ecc71' : '#e74c3c'};">${challengerWin ? 'âœ“ SUCCESS' : 'âœ— FAILED'}</p>
            </div>
            <div style="border:2px solid #8e7b55; padding:15px; border-radius:5px;">
                <b>${opponent.pName}</b>
                <p style="font-size:12px;">Spent: ${friendChallengeData.opponentSpend}</p>
                ${opponentInfo}
                <p style="font-size:12px;">Affinity: +${opponentBonus}</p>
                <p style="font-size:20px; color:var(--gold);"><b>${friendChallengeData.opponentAutoWin ? 'AUTO' : opponentTotal}</b></p>
                <p style="color:${opponentWin ? '#2ecc71' : '#e74c3c'};">${opponentWin ? 'âœ“ SUCCESS' : 'âœ— FAILED'}</p>
            </div>
        </div>
        <p style="font-size:12px;">Target: <b>${pTarget}</b></p>
        <button class="btn btn-main" onclick="finalizeFriendChallenge(${challengerWin}, ${opponentWin})">Continue</button>`
    );
}

function finalizeFriendChallenge(challengerWin, opponentWin) {
    const challenger = party[friendChallengeData.challenger];
    const opponent = party[friendChallengeData.opponent];
    
    let message = '';
    let anyoneWon = false;
    let passiveTriggers = '';
    
    if(challengerWin && opponentWin) {
        // Both win
        challenger.score += pPts;
        opponent.score += pPts;
        challenger.cur[pStage.s] += 2;
        opponent.cur[pStage.s] += 2;
        message = `Both ${challenger.pName} and ${opponent.pName} succeed! +${pPts} Glory each!`;
        anyoneWon = true;
        
        // Check for Friendly AI recharge
        if(challenger.n === 'Friendly AI' && passiveUsed[friendChallengeData.challenger]) {
            passiveUsed[friendChallengeData.challenger] = false;
            passiveTriggers += `<p style="color:#f3cf7a; font-size:12px;">âš¡ ${challenger.pName}'s System Override Recharged!</p>`;
        }
        if(opponent.n === 'Friendly AI' && passiveUsed[friendChallengeData.opponent]) {
            passiveUsed[friendChallengeData.opponent] = false;
            passiveTriggers += `<p style="color:#f3cf7a; font-size:12px;">âš¡ ${opponent.pName}'s System Override Recharged!</p>`;
        }
        
        // Check for Neighbor Witch recharge (both win)
        if(challenger.n === 'Neighbor Witch') {
            witchWins[friendChallengeData.challenger] = (witchWins[friendChallengeData.challenger] || 0) + 1;
            if(witchWins[friendChallengeData.challenger] >= 3 && passiveUsed[friendChallengeData.challenger]) {
                passiveUsed[friendChallengeData.challenger] = false;
                witchWins[friendChallengeData.challenger] = 0;
                passiveTriggers += `<p style="color:#f3cf7a; font-size:12px;">âš¡ ${challenger.pName}'s Arcane Alliance Recharged!</p>`;
            }
        }
        if(opponent.n === 'Neighbor Witch') {
            witchWins[friendChallengeData.opponent] = (witchWins[friendChallengeData.opponent] || 0) + 1;
            if(witchWins[friendChallengeData.opponent] >= 3 && passiveUsed[friendChallengeData.opponent]) {
                passiveUsed[friendChallengeData.opponent] = false;
                witchWins[friendChallengeData.opponent] = 0;
                passiveTriggers += `<p style="color:#f3cf7a; font-size:12px;">âš¡ ${opponent.pName}'s Arcane Alliance Recharged!</p>`;
            }
        }
    } else if(challengerWin) {
        challenger.score += pPts * 2; // Double glory for solo win
        challenger.cur[pStage.s] += 2;
        message = `${challenger.pName} wins solo! +${pPts * 2} Glory!`;
        anyoneWon = true;
        
        // Check for Friendly AI recharge
        if(challenger.n === 'Friendly AI' && passiveUsed[friendChallengeData.challenger]) {
            passiveUsed[friendChallengeData.challenger] = false;
            passiveTriggers += `<p style="color:#f3cf7a; font-size:12px;">âš¡ System Override Recharged!</p>`;
        }
        
        // Check for Neighbor Witch recharge
        if(challenger.n === 'Neighbor Witch') {
            witchWins[friendChallengeData.challenger] = (witchWins[friendChallengeData.challenger] || 0) + 1;
            if(witchWins[friendChallengeData.challenger] >= 3 && passiveUsed[friendChallengeData.challenger]) {
                passiveUsed[friendChallengeData.challenger] = false;
                witchWins[friendChallengeData.challenger] = 0;
                passiveTriggers += `<p style="color:#f3cf7a; font-size:12px;">âš¡ Arcane Alliance Recharged!</p>`;
            }
        }
    } else if(opponentWin) {
        opponent.score += pPts * 2;
        opponent.cur[pStage.s] += 2;
        message = `${opponent.pName} wins solo! +${pPts * 2} Glory!`;
        anyoneWon = true;
        
        // Check for Friendly AI recharge
        if(opponent.n === 'Friendly AI' && passiveUsed[friendChallengeData.opponent]) {
            passiveUsed[friendChallengeData.opponent] = false;
            passiveTriggers += `<p style="color:#f3cf7a; font-size:12px;">âš¡ System Override Recharged!</p>`;
        }
        
        // Check for Neighbor Witch recharge
        if(opponent.n === 'Neighbor Witch') {
            witchWins[friendChallengeData.opponent] = (witchWins[friendChallengeData.opponent] || 0) + 1;
            if(witchWins[friendChallengeData.opponent] >= 3 && passiveUsed[friendChallengeData.opponent]) {
                passiveUsed[friendChallengeData.opponent] = false;
                witchWins[friendChallengeData.opponent] = 0;
                passiveTriggers += `<p style="color:#f3cf7a; font-size:12px;">âš¡ Arcane Alliance Recharged!</p>`;
            }
        }
    } else {
        message = `Both failed! No glory earned.`;
    }
    
    updatePartyUI();
    
    showModal(
        anyoneWon ? "ðŸ† Duel Complete!" : "ðŸ’€ Dual Failure",
        message,
        `${passiveTriggers}<button class="btn btn-main" onclick="${anyoneWon ? 'challengeWon()' : 'challengeFailed()'}">Continue</button>`
    );
}

// ============================================================
// FRIEND CHALLENGE PASSIVE ABILITIES
// ============================================================

function useFriendSystemOverride(role) {
    const playerIdx = role === 'challenger' ? friendChallengeData.challenger : friendChallengeData.opponent;
    const h = party[playerIdx];
    passiveUsed[playerIdx] = true;
    
    showModal(
        "âš¡ System Override",
        "Choose which stat to use",
        `<div style="margin: 15px 0;">
            <img src="${h.i}" style="width: 80px; height: 80px; border: 3px solid var(--gold); background: #000;">
        </div>
        <p style="font-size:14px;">Select attribute to use instead of ${pStage.s.toUpperCase()}:</p>
        <select id="friend-override-stat" class="input-hero" style="width:100%; font-size:16px; padding:10px; margin:15px 0;">
            <option value="pow">POW: ${h.cur.pow}</option>
            <option value="spd">SPD: ${h.cur.spd}</option>
            <option value="brn">BRN: ${h.cur.brn}</option>
            <option value="cha">CHA: ${h.cur.cha}</option>
            <option value="wil">WIL: ${h.cur.wil}</option>
        </select>
        <p style="font-size:14px;">How many points to spend?</p>
        <input type="number" id="friend-override-amt" class="input-hero" value="0" min="0" style="width:100%; font-size:24px; text-align:center; margin:10px 0;">
        <button class="btn btn-main" onclick="executeFriendSystemOverride('${role}')">Commit</button>`
    );
}

function executeFriendSystemOverride(role) {
    const playerIdx = role === 'challenger' ? friendChallengeData.challenger : friendChallengeData.opponent;
    const h = party[playerIdx];
    const chosenStat = document.getElementById('friend-override-stat').value;
    const spend = parseInt(document.getElementById('friend-override-amt').value) || 0;
    
    if(spend > h.cur[chosenStat]) {
        alert("Not enough points!");
        return;
    }
    
    // Store the override info
    if(role === 'challenger') {
        friendChallengeData.challengerSpend = spend;
        friendChallengeData.challengerOwnSpend = spend;
        friendChallengeData.challengerOverrideStat = chosenStat;
        friendOpponentInvest();
    } else {
        friendChallengeData.opponentSpend = spend;
        friendChallengeData.opponentOwnSpend = spend;
        friendChallengeData.opponentOverrideStat = chosenStat;
        resolveFriendChallenge();
    }
}

function useFriendArcaneAlliance(role) {
    const playerIdx = role === 'challenger' ? friendChallengeData.challenger : friendChallengeData.opponent;
    const h = party[playerIdx];
    passiveUsed[playerIdx] = true;
    
    // Get other players (excluding both challenger and opponent for fairness)
    const otherIdx = role === 'challenger' ? friendChallengeData.opponent : friendChallengeData.challenger;
    let otherPlayers = party.filter((p, i) => i !== playerIdx && i !== otherIdx);
    
    if(otherPlayers.length === 0) {
        alert("No other players to steal from!");
        passiveUsed[playerIdx] = false;
        return;
    }
    
    let playerOptions = otherPlayers.map((p) => {
        let realIdx = party.indexOf(p);
        return `<option value="${realIdx}">${p.pName} - ${pStage.s.toUpperCase()}: ${p.cur[pStage.s]}</option>`;
    }).join('');
    
    showModal(
        "âš¡ Arcane Alliance",
        "Steal power permanently from another player",
        `<div style="margin: 15px 0;">
            <img src="${h.i}" style="width: 80px; height: 80px; border: 3px solid var(--gold); background: #000;">
        </div>
        <p style="font-size:14px;">Choose a player to steal ${pStage.s.toUpperCase()} from:</p>
        <select id="friend-borrow-player" class="input-hero" style="width:100%; font-size:14px; padding:10px; margin:10px 0;">
            ${playerOptions}
        </select>
        <p style="font-size:14px;">How many points to steal (max 3)?</p>
        <input type="number" id="friend-borrow-amt" class="input-hero" value="1" min="0" max="3" style="width:80px; font-size:24px; text-align:center; margin:10px 0;">
        <p style="font-size:12px; color:#666;">Your ${pStage.s.toUpperCase()}: ${h.cur[pStage.s]}</p>
        <p style="font-size:14px; margin-top:10px;">How many of YOUR points to add?</p>
        <input type="number" id="friend-own-amt" class="input-hero" value="0" min="0" max="${h.cur[pStage.s]}" style="width:80px; font-size:24px; text-align:center; margin:10px 0;">
        <button class="btn btn-main" onclick="executeFriendArcaneAlliance('${role}')">Commit</button>`
    );
}

function executeFriendArcaneAlliance(role) {
    const playerIdx = role === 'challenger' ? friendChallengeData.challenger : friendChallengeData.opponent;
    const h = party[playerIdx];
    
    const allyIdx = parseInt(document.getElementById('friend-borrow-player').value);
    const ally = party[allyIdx];
    const borrowAmt = parseInt(document.getElementById('friend-borrow-amt').value) || 0;
    const ownAmt = parseInt(document.getElementById('friend-own-amt').value) || 0;
    
    if(borrowAmt > ally.cur[pStage.s]) {
        alert(`${ally.pName} doesn't have enough ${pStage.s.toUpperCase()} points!`);
        return;
    }
    
    if(ownAmt > h.cur[pStage.s]) {
        alert("You don't have enough points!");
        return;
    }
    
    // Deduct from ally now
    ally.cur[pStage.s] -= borrowAmt;
    
    // Store total spend
    const totalSpend = ownAmt + borrowAmt;
    
    if(role === 'challenger') {
        friendChallengeData.challengerSpend = totalSpend;
        friendChallengeData.challengerOwnSpend = ownAmt;
        friendChallengeData.challengerBorrowAmt = borrowAmt;
        friendChallengeData.challengerBorrowFrom = ally.pName;
        friendOpponentInvest();
    } else {
        friendChallengeData.opponentSpend = totalSpend;
        friendChallengeData.opponentOwnSpend = ownAmt;
        friendChallengeData.opponentBorrowAmt = borrowAmt;
        friendChallengeData.opponentBorrowFrom = ally.pName;
        resolveFriendChallenge();
    }
    
    updatePartyUI();
}

function useFriendLiquidCourage(role) {
    const playerIdx = role === 'challenger' ? friendChallengeData.challenger : friendChallengeData.opponent;
    const h = party[playerIdx];
    passiveUsed[playerIdx] = true;
    
    showModal("ðŸº Liquid Courage!", "Rolling...", `<div id="dice-container" style="margin: 30px 0;"></div>`);
    
    let rollCount = 0;
    const rollInterval = setInterval(() => {
        const randomNum = Math.floor(Math.random() * 6) + 1;
        document.getElementById('dice-container').innerHTML = renderDice(randomNum);
        rollCount++;
        if(rollCount >= 8) clearInterval(rollInterval);
    }, 100);
    
    setTimeout(() => {
        clearInterval(rollInterval);
        const roll = Math.floor(Math.random() * 6) + 1;
        document.getElementById('dice-container').innerHTML = renderDice(roll);
        
        setTimeout(() => {
            if(roll >= 5) {
                // Auto-win!
                if(role === 'challenger') {
                    friendChallengeData.challengerSpend = 0;
                    friendChallengeData.challengerOwnSpend = 0;
                    friendChallengeData.challengerAutoWin = true;
                } else {
                    friendChallengeData.opponentSpend = 0;
                    friendChallengeData.opponentOwnSpend = 0;
                    friendChallengeData.opponentAutoWin = true;
                }
                
                showModal(
                    "ðŸº LIQUID COURAGE SUCCESS!",
                    "The spirits favor you!",
                    `<p style="color:#4caf50; font-size:20px;">Rolled ${roll}! AUTO-WIN!</p>
                    <p>${h.pName} automatically wins the challenge!</p>
                    <button class="btn btn-main" onclick="${role === 'challenger' ? 'friendOpponentInvest()' : 'resolveFriendChallengeWithAutoWin()'}">Continue</button>`
                );
            } else {
                // Failed - continue normally
                showModal(
                    "ðŸº Liquid Courage Failed",
                    "The spirits are fickle...",
                    `<p style="color:#e74c3c; font-size:20px;">Rolled ${roll}. Needed 5+</p>
                    <p>You must invest normally.</p>
                    <button class="btn btn-main" onclick="${role === 'challenger' ? 'friendChallengerInvestNormal()' : 'friendOpponentInvestNormal()'}">Continue</button>`
                );
            }
        }, 500);
    }, 1000);
}

function friendChallengerInvestNormal() {
    const challenger = party[friendChallengeData.challenger];
    
    showModal(
        `${challenger.pName}'s Investment`,
        "You have +3 Courage Bonus!",
        `<div style="margin: 15px 0;">
            <img src="${challenger.i}" style="width: 80px; height: 80px; border: 3px solid var(--gold); background: #000;">
        </div>
        <p>Your ${pStage.s.toUpperCase()}: <b>${challenger.cur[pStage.s]}</b></p>
        <input type="number" id="friend-amt-1" class="input-hero" value="0" min="0" max="${challenger.cur[pStage.s]}" style="width:100%; font-size:30px; text-align:center; margin:10px 0;">
        <button class="btn btn-main" onclick="setFriendChallengerBet()">Commit</button>`
    );
}

function friendOpponentInvestNormal() {
    const opponent = party[friendChallengeData.opponent];
    
    showModal(
        `${opponent.pName}'s Investment`,
        "How much will you risk?",
        `<div style="margin: 15px 0;">
            <img src="${opponent.i}" style="width: 80px; height: 80px; border: 3px solid var(--gold); background: #000;">
        </div>
        <p>Your ${pStage.s.toUpperCase()}: <b>${opponent.cur[pStage.s]}</b></p>
        <input type="number" id="friend-amt-2" class="input-hero" value="0" min="0" max="${opponent.cur[pStage.s]}" style="width:100%; font-size:30px; text-align:center; margin:10px 0;">
        <button class="btn btn-main" onclick="setFriendOpponentBet()">Commit</button>`
    );
}

function resolveFriendChallengeWithAutoWin() {
    const challenger = party[friendChallengeData.challenger];
    const opponent = party[friendChallengeData.opponent];
    
    // Handle stat overrides for deduction
    const challengerStat = friendChallengeData.challengerOverrideStat || pStage.s;
    const opponentStat = friendChallengeData.opponentOverrideStat || pStage.s;
    
    // Calculate own spend (accounts for borrowed points)
    const challengerOwnSpend = friendChallengeData.challengerOwnSpend !== undefined ? friendChallengeData.challengerOwnSpend : friendChallengeData.challengerSpend;
    const opponentOwnSpend = friendChallengeData.opponentOwnSpend !== undefined ? friendChallengeData.opponentOwnSpend : friendChallengeData.opponentSpend;
    
    // Deduct points from the correct stat
    challenger.cur[challengerStat] -= challengerOwnSpend;
    opponent.cur[opponentStat] -= opponentOwnSpend;
    
    // Calculate totals
    let challengerBonus = (Array.isArray(pStage.a) ? pStage.a.includes(challenger.a) : challenger.a === pStage.a) ? 3 : 0;
    let opponentBonus = (Array.isArray(pStage.a) ? pStage.a.includes(opponent.a) : opponent.a === pStage.a) ? 3 : 0;
    
    // Dragon Rage
    if(challenger.n === 'Lost Dragon' && friendChallengeData.challengerSpend >= 4) challengerBonus += 3;
    if(opponent.n === 'Lost Dragon' && friendChallengeData.opponentSpend >= 4) opponentBonus += 3;
    
    let challengerTotal = friendChallengeData.challengerSpend + challengerBonus + 3;
    let opponentTotal = friendChallengeData.opponentSpend + opponentBonus;
    
    // Auto-wins override the normal check
    let challengerWin = friendChallengeData.challengerAutoWin || (challengerTotal >= pTarget);
    let opponentWin = friendChallengeData.opponentAutoWin || (opponentTotal >= pTarget);
    
    // Build info strings for passives used
    let challengerInfo = '';
    if(friendChallengeData.challengerAutoWin) {
        challengerInfo += `<p style="font-size:10px; color:#4caf50;">ðŸº LIQUID COURAGE AUTO-WIN!</p>`;
    }
    if(friendChallengeData.challengerOverrideStat) {
        challengerInfo += `<p style="font-size:10px; color:#9370DB;">âš¡ Used ${challengerStat.toUpperCase()}</p>`;
    }
    if(friendChallengeData.challengerBorrowAmt) {
        challengerInfo += `<p style="font-size:10px; color:#9370DB;">âš¡ Stole ${friendChallengeData.challengerBorrowAmt} from ${friendChallengeData.challengerBorrowFrom}</p>`;
    }
    
    let opponentInfo = '';
    if(friendChallengeData.opponentAutoWin) {
        opponentInfo += `<p style="font-size:10px; color:#4caf50;">ðŸº LIQUID COURAGE AUTO-WIN!</p>`;
    }
    if(friendChallengeData.opponentOverrideStat) {
        opponentInfo += `<p style="font-size:10px; color:#9370DB;">âš¡ Used ${opponentStat.toUpperCase()}</p>`;
    }
    if(friendChallengeData.opponentBorrowAmt) {
        opponentInfo += `<p style="font-size:10px; color:#9370DB;">âš¡ Stole ${friendChallengeData.opponentBorrowAmt} from ${friendChallengeData.opponentBorrowFrom}</p>`;
    }
    
    updatePartyUI();
    
    // Show results
    showModal(
        "Duel Results",
        "Who proved worthy?",
        `<div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin:20px 0;">
            <div style="border:2px solid var(--gold); padding:15px; border-radius:5px; background: rgba(197, 160, 89, 0.1);">
                <b>${challenger.pName}</b>
                <p style="font-size:12px;">Spent: ${friendChallengeData.challengerSpend}</p>
                ${challengerInfo}
                <p style="font-size:12px;">Courage: +3</p>
                <p style="font-size:12px;">Affinity: +${challengerBonus}</p>
                <p style="font-size:20px; color:var(--gold);"><b>${friendChallengeData.challengerAutoWin ? 'AUTO' : challengerTotal}</b></p>
                <p style="color:${challengerWin ? '#2ecc71' : '#e74c3c'};">${challengerWin ? 'âœ“ SUCCESS' : 'âœ— FAILED'}</p>
            </div>
            <div style="border:2px solid #8e7b55; padding:15px; border-radius:5px;">
                <b>${opponent.pName}</b>
                <p style="font-size:12px;">Spent: ${friendChallengeData.opponentSpend}</p>
                ${opponentInfo}
                <p style="font-size:12px;">Affinity: +${opponentBonus}</p>
                <p style="font-size:20px; color:var(--gold);"><b>${friendChallengeData.opponentAutoWin ? 'AUTO' : opponentTotal}</b></p>
                <p style="color:${opponentWin ? '#2ecc71' : '#e74c3c'};">${opponentWin ? 'âœ“ SUCCESS' : 'âœ— FAILED'}</p>
            </div>
        </div>
        <p style="font-size:12px;">Target: <b>${pTarget}</b></p>
        <button class="btn btn-main" onclick="finalizeFriendChallenge(${challengerWin}, ${opponentWin})">Continue</button>`
    );
}

// ============================================================
// GROUP MISSIONS - Reader cannot participate
// ============================================================

let groupChallengeContributions = [];
let groupChallengeVotes = [];
let groupChallengeVotingIndex = 0;

function readerSetsDifficultyGroup(m, pts) {
    pTarget = pStage[m];
    pPts = pts;
    
    document.getElementById('st-title').innerText = "ðŸ¤ " + pStage.t;
    document.getElementById('st-desc').innerText = pStage.d;
    document.getElementById('st-req').innerText = `REQUIRED: ${pStage.s.toUpperCase()} | TARGET: ??? | +${pPts * 2} GLORY EACH`;
    
    document.getElementById('draw-btn').style.display = 'none';
    document.getElementById('game-controls').style.display = 'none';
    
    closeModal();
    startGroupVoting();
}

function startGroupVoting() {
    groupChallengeVotes = [];
    groupChallengeVotingIndex = 0;
    
    // Skip the reader
    if(groupChallengeVotingIndex === readerIdx) {
        groupChallengeVotingIndex++;
    }
    
    collectGroupVote();
}

function collectGroupVote() {
    // Skip reader
    while(groupChallengeVotingIndex === readerIdx) {
        groupChallengeVotingIndex++;
    }
    
    if(groupChallengeVotingIndex >= party.length) {
        // All votes collected
        const yesVotes = groupChallengeVotes.filter(v => v.vote === 'yes');
        
        if(yesVotes.length === 0) {
            showModal("ðŸ¤ Group Mission Declined", "No one wants to participate!", `
                <p>The group mission is discarded.</p>
                <button class="btn btn-main" onclick="missionDiscarded()">Next Mission</button>
            `);
        } else {
            startGroupContributions();
        }
        return;
    }
    
    const currentHero = party[groupChallengeVotingIndex];
    
    showModal(
        `${currentHero.pName}'s Decision`,
        `Will you join this group mission?`,
        `<div style="margin: 15px 0;">
            <img src="${currentHero.i}" style="width: 80px; height: 80px; border: 3px solid var(--gold); background: #000;">
        </div>
        <p style="color: var(--blood);">Mission: ${pStage.t}</p>
        <p>Required: <b>${pStage.s.toUpperCase()}</b> | Target: <b style="color:var(--blood);">???</b></p>
        <p>Your ${pStage.s.toUpperCase()}: <b style="color: var(--gold);">${currentHero.cur[pStage.s]}</b></p>
        <hr style="border: 0; border-top: 1px solid #8e7b55; margin: 15px 0;">
        <p style="font-size:12px;">âœ“ Success: +${pPts * 2} Glory, +2 stat recovered</p>
        <p style="font-size:12px; color:var(--blood);">âœ— Fail: Lose stats (scaled by # of participants)</p>
        <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="btn btn-main" style="background: #1b5e20; border-color: #4caf50;" onclick="voteGroup('yes')">âœ“ JOIN</button>
            <button class="btn btn-skip" onclick="voteGroup('no')">âœ— PASS</button>
        </div>`
    );
}

function voteGroup(vote) {
    groupChallengeVotes.push({
        playerIndex: groupChallengeVotingIndex,
        vote: vote
    });
    
    groupChallengeVotingIndex++;
    collectGroupVote();
}

function startGroupContributions() {
    groupChallengeContributions = [];
    const yesVoters = groupChallengeVotes.filter(v => v.vote === 'yes');
    
    collectGroupContribution(0, yesVoters);
}

function collectGroupContribution(idx, yesVoters) {
    if(idx >= yesVoters.length) {
        resolveGroupChallenge(yesVoters);
        return;
    }
    
    const voterData = yesVoters[idx];
    const currentHero = party[voterData.playerIndex];
    const playerIdx = voterData.playerIndex;
    
    // Check for passives
    let canUseOverride = (currentHero.n === 'Friendly AI' && !passiveUsed[playerIdx]);
    let canUseArcaneAlliance = (currentHero.n === 'Neighbor Witch' && !passiveUsed[playerIdx]);
    
    let passiveOptions = '';
    if(canUseOverride) {
        passiveOptions = `<button class="btn btn-main" style="background:#2b1010; border-color:#8b0000; margin-top:10px;" onclick="useGroupSystemOverride(${idx}, ${JSON.stringify(yesVoters).replace(/"/g, '&quot;')})">âš¡ System Override (Use Different Stat)</button>`;
    } else if(canUseArcaneAlliance) {
        passiveOptions = `<button class="btn btn-main" style="background:#2b1010; border-color:#8b0000; margin-top:10px;" onclick="useGroupArcaneAlliance(${idx}, ${JSON.stringify(yesVoters).replace(/"/g, '&quot;')})">ðŸ”® Arcane Alliance (Steal Points)</button>`;
    }
    
    // Dragon Rage note
    let dragonNote = '';
    if(currentHero.n === 'Lost Dragon') {
        dragonNote = `<p style="font-size: 12px; color: #FF6347; margin-top: 8px;">âš¡ Dragon Rage: Contribute 4+ for +3 bonus!</p>`;
    }
    
    showModal(
        `${currentHero.pName}'s Contribution`,
        `How much ${pStage.s.toUpperCase()} will you contribute?`,
        `<div style="margin: 15px 0;">
            <img src="${currentHero.i}" style="width: 80px; height: 80px; border: 3px solid var(--gold); background: #000;">
        </div>
        <p>Available ${pStage.s.toUpperCase()}: <b style="color: var(--gold);">${currentHero.cur[pStage.s]}</b></p>
        ${dragonNote}
        <input type="number" id="group-contrib" class="input-hero" min="0" max="${currentHero.cur[pStage.s]}" value="0" style="width:100%; font-size:24px; text-align:center; margin:15px 0;">
        <button class="btn btn-main" onclick="submitGroupContrib(${idx}, ${JSON.stringify(yesVoters).replace(/"/g, '&quot;')})">Contribute</button>
        ${passiveOptions}`
    );
}

function submitGroupContrib(idx, yesVoters) {
    const voterData = yesVoters[idx];
    const currentHero = party[voterData.playerIndex];
    const contribution = parseInt(document.getElementById('group-contrib').value) || 0;
    
    if(contribution > currentHero.cur[pStage.s]) {
        alert("Not enough points!");
        return;
    }
    
    // Deduct and record
    currentHero.cur[pStage.s] -= contribution;
    
    // Calculate bonuses
    let affinityBonus = (Array.isArray(pStage.a) ? pStage.a.includes(currentHero.a) : currentHero.a === pStage.a) ? 3 : 0;
    let dragonBonus = (currentHero.n === 'Lost Dragon' && contribution >= 4) ? 3 : 0;
    
    groupChallengeContributions.push({
        playerIndex: voterData.playerIndex,
        playerName: currentHero.pName,
        contribution: contribution,
        total: contribution + affinityBonus + dragonBonus
    });
    
    updatePartyUI();
    collectGroupContribution(idx + 1, yesVoters);
}

function resolveGroupChallenge(yesVoters) {
    const totalContribution = groupChallengeContributions.reduce((sum, c) => sum + c.total, 0);
    const success = totalContribution >= pTarget;
    const numParticipants = yesVoters.length;
    
    // Build summary
    let contributionSummary = groupChallengeContributions.map(c => 
        `<div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px;">
            <span>${c.playerName}</span>
            <span><b>${c.total}</b></span>
        </div>`
    ).join('');
    
    if(success) {
        // Everyone who participated gets glory
        yesVoters.forEach(v => {
            const p = party[v.playerIndex];
            p.score += pPts * 2;
            
            // Find their contribution for stat recovery
            const contrib = groupChallengeContributions.find(c => c.playerIndex === v.playerIndex);
            if(contrib && contrib.contribution > 0) {
                p.cur[pStage.s] += 2;
            }
            
            // Passive triggers
            if(p.n === 'Thug Dwarf') p.cur.pow += 3;
            
            challengesCompleted[v.playerIndex] = (challengesCompleted[v.playerIndex] || 0) + 1;
            if(p.n === 'Babbler Rogue' && challengesCompleted[v.playerIndex] % 3 === 0) {
                p.score += 1;
            }
        });
        
        showModal(
            "ðŸ† GROUP SUCCESS!",
            pStage.t,
            `<div style="text-align: left; background: rgba(0,0,0,0.1); padding: 10px; margin: 15px 0;">
                ${contributionSummary}
                <hr style="border-top: 1px solid #8e7b55; margin: 10px 0;">
                <div style="display: flex; justify-content: space-between; font-weight: bold;">
                    <span>TOTAL:</span>
                    <span style="color: var(--gold);">${totalContribution} / ${pTarget}</span>
                </div>
            </div>
            <p style="color:#1b5e20; font-weight:bold;">All participants gain +${pPts * 2} Glory!</p>
            <button class="btn btn-main" onclick="finishGroupChallenge()">Continue</button>`
        );
    } else {
        // Failure - participants lose stats scaled by number of participants
        const statLoss = numParticipants; // -1 per participant
        
        yesVoters.forEach(v => {
            const p = party[v.playerIndex];
            p.cur.pow = Math.max(0, p.cur.pow - statLoss);
            p.cur.spd = Math.max(0, p.cur.spd - statLoss);
            p.cur.brn = Math.max(0, p.cur.brn - statLoss);
            p.cur.cha = Math.max(0, p.cur.cha - statLoss);
            p.cur.wil = Math.max(0, p.cur.wil - statLoss);
        });
        
        showModal(
            "ðŸ’€ GROUP FAILED!",
            pStage.t,
            `<div style="text-align: left; background: rgba(0,0,0,0.1); padding: 10px; margin: 15px 0;">
                ${contributionSummary}
                <hr style="border-top: 1px solid #8e7b55; margin: 10px 0;">
                <div style="display: flex; justify-content: space-between; font-weight: bold;">
                    <span>TOTAL:</span>
                    <span style="color: var(--blood);">${totalContribution} / ${pTarget}</span>
                </div>
            </div>
            <p style="color:var(--blood); font-weight:bold;">
                ${numParticipants} participants = -${statLoss} to ALL stats each!
            </p>
            <button class="btn btn-main" onclick="finishGroupChallenge()">Accept Defeat</button>`
        );
    }
    
    updatePartyUI();
}

function finishGroupChallenge() {
    groupChallengeContributions = [];
    groupChallengeVotes = [];
    closeModal();
    advanceToNextRound();
}

// ============================================================
// GROUP MISSION PASSIVES
// ============================================================

// Store group passive data
let groupPassiveData = {};

function useGroupSystemOverride(idx, yesVoters) {
    const voterData = yesVoters[idx];
    const playerIdx = voterData.playerIndex;
    const h = party[playerIdx];
    passiveUsed[playerIdx] = true;
    
    showModal(
        "âš¡ System Override",
        "Choose which stat to use",
        `<div style="margin: 15px 0;">
            <img src="${h.i}" style="width: 80px; height: 80px; border: 3px solid var(--gold); background: #000;">
        </div>
        <p style="font-size:14px;">Select attribute to use instead of ${pStage.s.toUpperCase()}:</p>
        <select id="group-override-stat" class="input-hero" style="width:100%; font-size:16px; padding:10px; margin:15px 0;">
            <option value="pow">POW: ${h.cur.pow}</option>
            <option value="spd">SPD: ${h.cur.spd}</option>
            <option value="brn">BRN: ${h.cur.brn}</option>
            <option value="cha">CHA: ${h.cur.cha}</option>
            <option value="wil">WIL: ${h.cur.wil}</option>
        </select>
        <p style="font-size:14px;">How many points to contribute?</p>
        <input type="number" id="group-override-amt" class="input-hero" value="0" min="0" style="width:100%; font-size:24px; text-align:center; margin:10px 0;">
        <button class="btn btn-main" onclick="executeGroupSystemOverride(${idx}, ${JSON.stringify(yesVoters).replace(/"/g, '&quot;')})">Contribute</button>`
    );
}

function executeGroupSystemOverride(idx, yesVoters) {
    const voterData = yesVoters[idx];
    const playerIdx = voterData.playerIndex;
    const h = party[playerIdx];
    const chosenStat = document.getElementById('group-override-stat').value;
    const contribution = parseInt(document.getElementById('group-override-amt').value) || 0;
    
    if(contribution > h.cur[chosenStat]) {
        alert("Not enough points!");
        return;
    }
    
    // Deduct from chosen stat
    h.cur[chosenStat] -= contribution;
    
    // Calculate bonuses
    let affinityBonus = (Array.isArray(pStage.a) ? pStage.a.includes(h.a) : h.a === pStage.a) ? 3 : 0;
    let dragonBonus = (h.n === 'Lost Dragon' && contribution >= 4) ? 3 : 0;
    
    groupChallengeContributions.push({
        playerIndex: playerIdx,
        playerName: h.pName,
        contribution: contribution,
        total: contribution + affinityBonus + dragonBonus,
        usedOverride: chosenStat
    });
    
    updatePartyUI();
    collectGroupContribution(idx + 1, yesVoters);
}

function useGroupArcaneAlliance(idx, yesVoters) {
    const voterData = yesVoters[idx];
    const playerIdx = voterData.playerIndex;
    const h = party[playerIdx];
    passiveUsed[playerIdx] = true;
    
    // Get other players (excluding current player)
    let otherPlayers = party.filter((p, i) => i !== playerIdx);
    
    if(otherPlayers.length === 0) {
        alert("No other players to steal from!");
        passiveUsed[playerIdx] = false;
        return;
    }
    
    let playerOptions = otherPlayers.map((p) => {
        let realIdx = party.indexOf(p);
        return `<option value="${realIdx}">${p.pName} - ${pStage.s.toUpperCase()}: ${p.cur[pStage.s]}</option>`;
    }).join('');
    
    showModal(
        "ðŸ”® Arcane Alliance",
        "Steal power permanently from another player",
        `<div style="margin: 15px 0;">
            <img src="${h.i}" style="width: 80px; height: 80px; border: 3px solid var(--gold); background: #000;">
        </div>
        <p style="font-size:14px;">Choose a player to steal ${pStage.s.toUpperCase()} from:</p>
        <select id="group-borrow-player" class="input-hero" style="width:100%; font-size:14px; padding:10px; margin:10px 0;">
            ${playerOptions}
        </select>
        <p style="font-size:14px;">How many points to steal (max 3)?</p>
        <input type="number" id="group-borrow-amt" class="input-hero" value="1" min="0" max="3" style="width:80px; font-size:24px; text-align:center; margin:10px 0;">
        <p style="font-size:12px; color:#666;">Your ${pStage.s.toUpperCase()}: ${h.cur[pStage.s]}</p>
        <p style="font-size:14px; margin-top:10px;">How many of YOUR points to add?</p>
        <input type="number" id="group-own-amt" class="input-hero" value="0" min="0" max="${h.cur[pStage.s]}" style="width:80px; font-size:24px; text-align:center; margin:10px 0;">
        <button class="btn btn-main" onclick="executeGroupArcaneAlliance(${idx}, ${JSON.stringify(yesVoters).replace(/"/g, '&quot;')})">Contribute</button>`
    );
}

function executeGroupArcaneAlliance(idx, yesVoters) {
    const voterData = yesVoters[idx];
    const playerIdx = voterData.playerIndex;
    const h = party[playerIdx];
    
    const allyIdx = parseInt(document.getElementById('group-borrow-player').value);
    const ally = party[allyIdx];
    const borrowAmt = parseInt(document.getElementById('group-borrow-amt').value) || 0;
    const ownAmt = parseInt(document.getElementById('group-own-amt').value) || 0;
    
    if(borrowAmt > ally.cur[pStage.s]) {
        alert(`${ally.pName} doesn't have enough ${pStage.s.toUpperCase()} points!`);
        return;
    }
    
    if(ownAmt > h.cur[pStage.s]) {
        alert("You don't have enough points!");
        return;
    }
    
    // Deduct from ally
    ally.cur[pStage.s] -= borrowAmt;
    // Deduct own points
    h.cur[pStage.s] -= ownAmt;
    
    const totalContrib = ownAmt + borrowAmt;
    
    // Calculate bonuses
    let affinityBonus = (Array.isArray(pStage.a) ? pStage.a.includes(h.a) : h.a === pStage.a) ? 3 : 0;
    let dragonBonus = (h.n === 'Lost Dragon' && totalContrib >= 4) ? 3 : 0;
    
    groupChallengeContributions.push({
        playerIndex: playerIdx,
        playerName: h.pName,
        contribution: totalContrib,
        total: totalContrib + affinityBonus + dragonBonus,
        borrowed: borrowAmt,
        borrowedFrom: ally.pName
    });
    
    updatePartyUI();
    collectGroupContribution(idx + 1, yesVoters);
}

// ============================================================
// PASSIVES
// ============================================================

function rollPaladinDice() {
    const h = party[activeIdx];
    h.paladinDiceUsedThisTurn = true;
    
    showModal("ðŸº Liquid Courage!", "Rolling...", `<div id="dice-container" style="margin: 30px 0;"></div>`);
    
    let rollCount = 0;
    const rollInterval = setInterval(() => {
        const randomNum = Math.floor(Math.random() * 6) + 1;
        document.getElementById('dice-container').innerHTML = renderDice(randomNum);
        rollCount++;
        if(rollCount >= 8) clearInterval(rollInterval);
    }, 100);
    
    setTimeout(() => {
        clearInterval(rollInterval);
        const roll = Math.floor(Math.random() * 6) + 1;
        document.getElementById('dice-container').innerHTML = renderDice(roll);
        
        setTimeout(() => {
            if(roll >= 5) {
                h.score += pPts;
                h.cur[pStage.s] += 2;
                challengesCompleted[activeIdx]++;
                
                if(h.n === 'Lover Zombie') {
                    updatePartyUI();
                    selectLoverZombieDebuff();
                    return;
                }
                
                showModal(
                    "âš¡ MIRACULOUS VICTORY!",
                    `Rolled a ${roll}!`,
                    `<p>Auto-win! +${pPts} Glory!</p>
                    <button class="btn btn-main" onclick="challengeWon()">Continue</button>`
                );
                updatePartyUI();
            } else {
                showModal(
                    "Dice Failed",
                    `Rolled a ${roll}`,
                    `<p>Need 5 or 6. Must attempt normally.</p>
                    <button class="btn btn-main" onclick="startFight()">Try Challenge</button>`
                );
            }
        }, 500);
    }, 900);
}

function useSystemOverride() {
    const h = party[activeIdx];
    passiveUsed[activeIdx] = true;
    
    showModal("âš¡ System Override", "Choose stat to use", `
        <select id="override-stat" class="input-hero" style="width:100%; font-size:18px; padding:10px; margin:15px 0;">
            <option value="pow">POW (${h.cur.pow})</option>
            <option value="spd">SPD (${h.cur.spd})</option>
            <option value="brn">BRN (${h.cur.brn})</option>
            <option value="cha">CHA (${h.cur.cha})</option>
            <option value="wil">WIL (${h.cur.wil})</option>
        </select>
        <p>Spend how many?</p>
        <input type="number" id="override-amt" value="1" class="input-hero" style="width:80px; text-align:center; font-size: 24px; margin: 10px 0;">
        <button class="btn btn-main" style="margin-top:20px;" onclick="processOverrideAttempt()">Attempt!</button>
    `);
}

function processOverrideAttempt() {
    const h = party[activeIdx];
    const chosenStat = document.getElementById('override-stat').value;
    let spend = parseInt(document.getElementById('override-amt').value) || 0;
    
    if (spend > h.cur[chosenStat]) {
        alert("Not enough points!");
        return;
    }
    
    let affinityBonus = (Array.isArray(pStage.a) ? pStage.a.includes(h.a) : h.a === pStage.a) ? 3 : 0;
    let dragonBonus = (h.n === 'Lost Dragon' && spend >= 4) ? 3 : 0;
    
    let total = spend + affinityBonus + dragonBonus;
    h.cur[chosenStat] -= spend;
    
    showResult(spend, affinityBonus + dragonBonus, total, total >= pTarget, chosenStat);
}

function selectLoverZombieDebuff() {
    showModal("ðŸ’€ Cursed Embrace", "Choose a stat to drain from ALL players", `
        <select id="zombie-stat" class="input-hero" style="width:100%; font-size:18px; padding:10px; margin:15px 0;">
            <option value="pow">POW</option>
            <option value="spd">SPD</option>
            <option value="brn">BRN</option>
            <option value="cha">CHA</option>
            <option value="wil">WIL</option>
        </select>
        <p style="font-size:12px;">All others lose -2, you gain +1</p>
        <button class="btn btn-main" onclick="applyZombieDebuff()">Drain!</button>
    `);
}

function applyZombieDebuff() {
    const chosenStat = document.getElementById('zombie-stat').value;
    const zombie = party[activeIdx];
    
    party.forEach((p, idx) => {
        if(idx !== activeIdx) {
            p.cur[chosenStat] = Math.max(0, p.cur[chosenStat] - 2);
        }
    });
    zombie.cur[chosenStat] += 1;
    
    updatePartyUI();
    showModal(
        "ðŸ’€ Cursed Embrace!",
        `Drained ${chosenStat.toUpperCase()}!`,
        `<button class="btn btn-main" onclick="challengeWon()">Continue</button>`
    );
}

// ============================================================
// NEIGHBOR WITCH - ARCANE ALLIANCE
// ============================================================

function useArcaneAlliance() {
    const witch = party[activeIdx];
    
    // Build list of other players to steal from (including reader!)
    let playerOptions = '';
    party.forEach((p, idx) => {
        if(idx !== activeIdx) {
            const isReader = idx === readerIdx ? ' ðŸ“œ' : '';
            playerOptions += `<option value="${idx}">${p.pName} (${p.n})${isReader}</option>`;
        }
    });
    
    showModal(
        "ðŸ”® Arcane Alliance",
        "Steal stat points permanently from another player",
        `<div style="margin: 15px 0;">
            <img src="${witch.i}" style="width: 60px; height: 60px; border: 2px solid var(--gold); background: #000;">
        </div>
        <p>Choose a player to steal from:</p>
        <select id="witch-target" class="input-hero" style="width: 100%; padding: 10px; margin: 10px 0;">
            ${playerOptions}
        </select>
        <p style="margin-top: 10px;">Choose stat to steal:</p>
        <select id="witch-stat" class="input-hero" style="width: 100%; padding: 10px; margin: 10px 0;">
            <option value="pow">POWER</option>
            <option value="spd">SPEED</option>
            <option value="brn">BRAIN</option>
            <option value="cha">CHARISMA</option>
            <option value="wil">WILLPOWER</option>
        </select>
        <p style="margin-top: 10px;">How many points to steal (max 3):</p>
        <input type="number" id="witch-amount" value="1" min="1" max="3" class="input-hero" style="width: 80px; text-align: center; font-size: 20px;">
        <div style="margin-top: 15px;">
            <button class="btn btn-main" onclick="confirmArcaneAlliance()">Steal</button>
            <button class="btn btn-skip" onclick="startFight()">Cancel</button>
        </div>`
    );
}

function confirmArcaneAlliance() {
    const targetIdx = parseInt(document.getElementById('witch-target').value);
    const stat = document.getElementById('witch-stat').value;
    const amount = Math.min(3, parseInt(document.getElementById('witch-amount').value) || 1);
    
    const target = party[targetIdx];
    const witch = party[activeIdx];
    
    // Check if target has enough
    if(target.cur[stat] < amount) {
        alert(`${target.pName} doesn't have enough ${stat.toUpperCase()}!`);
        return;
    }
    
    // Transfer the stats PERMANENTLY
    target.cur[stat] -= amount;
    witch.cur[stat] += amount;
    
    // Mark as used
    passiveUsed[activeIdx] = true;
    witchBorrowedStats = {
        borrower: activeIdx,
        lender: targetIdx,
        stat: stat,
        amount: amount
    };
    
    updatePartyUI();
    
    showModal(
        "ðŸ”® Arcane Alliance!",
        `Stole ${amount} ${stat.toUpperCase()} from ${target.pName}!`,
        `<p>Your ${stat.toUpperCase()} is now: <b style="color: var(--gold);">${witch.cur[stat]}</b></p>
        <p style="font-size: 12px; color: var(--blood); margin-top: 10px;">âš ï¸ This transfer is PERMANENT!</p>
        <button class="btn btn-main" onclick="startFight()">Continue</button>`
    );
}

function returnBorrowedStats() {
    // Arcane Alliance is now PERMANENT - stats are not returned
    // Just clear the tracking variable
    witchBorrowedStats = null;
}

// ============================================================
// DARK STALKER - SHADOW CONTROL
// ============================================================

function canUseShadowControl(playerIdx) {
    const h = party[playerIdx];
    if(h.n !== 'Dark Stalker') return false;
    
    // Calculate max uses based on party size
    let maxUses = 1;
    if(party.length >= 4) maxUses = 3;
    else if(party.length >= 3) maxUses = 2;
    
    const usedCount = shadowControlUses[playerIdx] || 0;
    return usedCount < maxUses;
}

function useShadowControl() {
    const stalker = party[activeIdx];
    
    // Check if can use
    if(!canUseShadowControl(activeIdx)) {
        alert("Shadow Control has no uses remaining!");
        return;
    }
    
    // Build list of targets (players with meditations left)
    let targetOptions = '';
    let hasTargets = false;
    party.forEach((p, idx) => {
        if(idx !== activeIdx && p.skips > 0) {
            targetOptions += `<option value="${idx}">${p.pName} (${p.skips} meditations left)</option>`;
            hasTargets = true;
        }
    });
    
    if(!hasTargets) {
        showModal(
            "ðŸ—¡ï¸ Shadow Control",
            "No valid targets!",
            `<p>No other players have meditations remaining.</p>
            <button class="btn btn-main" onclick="closeModal()">OK</button>`
        );
        return;
    }
    
    let maxUses = party.length >= 4 ? 3 : (party.length >= 3 ? 2 : 1);
    let usedCount = shadowControlUses[activeIdx] || 0;
    
    showModal(
        "ðŸ—¡ï¸ Shadow Control",
        `Force a player to use a meditation (${maxUses - usedCount} uses left)`,
        `<div style="margin: 15px 0;">
            <img src="${stalker.i}" style="width: 60px; height: 60px; border: 2px solid var(--gold); background: #000;">
        </div>
        <p>Choose your victim:</p>
        <select id="shadow-target" class="input-hero" style="width: 100%; padding: 10px; margin: 10px 0;">
            ${targetOptions}
        </select>
        <div style="margin-top: 15px;">
            <button class="btn btn-main" onclick="confirmShadowControl()">Use Shadow Control</button>
            <button class="btn btn-skip" onclick="closeModal()">Cancel</button>
        </div>`
    );
}

function confirmShadowControl() {
    const targetIdx = parseInt(document.getElementById('shadow-target').value);
    const target = party[targetIdx];
    const stalker = party[activeIdx];
    
    // Use the meditation
    target.skips--;
    
    // Track usage
    shadowControlUses[activeIdx] = (shadowControlUses[activeIdx] || 0) + 1;
    
    updatePartyUI();
    
    showModal(
        "ðŸ—¡ï¸ Shadow Control!",
        `${target.pName} was forced to meditate!`,
        `<p>${target.pName} lost 1 meditation.</p>
        <p>They now have <b>${target.skips}</b> meditations remaining.</p>
        <button class="btn btn-main" onclick="closeModal()">Continue</button>`
    );
}

// ============================================================
// FANCY NINJA - ASSASSINATION CONTRACT
// ============================================================

function canUseAssassinationContract(playerIdx) {
    const h = party[playerIdx];
    if(h.n !== 'Fancy Ninja') return false;
    // Can use if no contract is currently active
    if(ninjaContract !== null) return false;
    return true;
}

function setupAssassinationContract() {
    const ninja = party[activeIdx];
    
    if(!canUseAssassinationContract(activeIdx)) {
        alert("You already have an active contract!");
        return;
    }
    
    // Build list of targets (other challengers - including reader for when they play later)
    let targetOptions = '';
    party.forEach((p, idx) => {
        if(idx !== activeIdx) {
            const isReader = idx === readerIdx ? ' ðŸ“œ (Reader)' : '';
            targetOptions += `<option value="${idx}">${p.pName} (${p.n})${isReader}</option>`;
        }
    });
    
    showModal(
        "ðŸ¥· Assassination Contract",
        "Bet on another player's failure",
        `<div style="margin: 15px 0;">
            <img src="${ninja.i}" style="width: 60px; height: 60px; border: 2px solid var(--gold); background: #000;">
        </div>
        <p>Choose your target:</p>
        <select id="ninja-target" class="input-hero" style="width: 100%; padding: 10px; margin: 10px 0;">
            ${targetOptions}
        </select>
        <p style="font-size: 12px; margin-top: 10px; color: #888;">
            If they <b style="color: var(--blood);">FAIL</b>: You steal +1 from one of their stats<br>
            If they <b style="color: #4caf50;">WIN</b>: You lose -1 from one of your stats
        </p>
        <div style="margin-top: 15px;">
            <button class="btn btn-main" onclick="confirmAssassinationContract()">Set Contract</button>
            <button class="btn btn-skip" onclick="closeModal()">Cancel</button>
        </div>`
    );
}

function confirmAssassinationContract() {
    const targetIdx = parseInt(document.getElementById('ninja-target').value);
    const target = party[targetIdx];
    
    // Find ninja player
    let ninjaIdx = -1;
    party.forEach((p, idx) => {
        if(p.n === 'Fancy Ninja') ninjaIdx = idx;
    });
    
    ninjaContract = {
        ninja: ninjaIdx,
        target: targetIdx,
        round: round,
        stat: pStage.s // Track the challenge stat
    };
    
    showModal(
        "ðŸ¥· Contract Set!",
        `Target: ${target.pName}`,
        `<p>You've placed a contract on ${target.pName}.</p>
        <p style="font-size: 12px; color: #888;">If they fail the challenge, you steal +1 ${pStage.s.toUpperCase()}.</p>
        <button class="btn btn-main" onclick="closeModal()">Continue</button>`
    );
}

function resolveNinjaContract(targetIdx, didWin) {
    if(!ninjaContract || ninjaContract.target !== targetIdx) return;
    
    const ninja = party[ninjaContract.ninja];
    const target = party[ninjaContract.target];
    const stat = ninjaContract.stat;
    
    if(didWin) {
        // Ninja loses -1 stat
        ninja.cur[stat] = Math.max(0, ninja.cur[stat] - 1);
        showModal(
            "ðŸ¥· Contract Failed!",
            `${target.pName} succeeded!`,
            `<p>${ninja.pName} loses -1 ${stat.toUpperCase()}</p>
            <button class="btn btn-main" onclick="closeModal()">Continue</button>`
        );
    } else {
        // Ninja steals +1 stat
        target.cur[stat] = Math.max(0, target.cur[stat] - 1);
        ninja.cur[stat] += 1;
        showModal(
            "ðŸ¥· Contract Fulfilled!",
            `${target.pName} failed!`,
            `<p>${ninja.pName} steals +1 ${stat.toUpperCase()} from ${target.pName}</p>
            <button class="btn btn-main" onclick="closeModal()">Continue</button>`
        );
    }
    
    ninjaContract = null;
    updatePartyUI();
}

// ============================================================
// SHOP SYSTEM
// ============================================================

function openStore() { 
    storePoints = 10; 
    tempStats = {pow:0, spd:0, brn:0, cha:0, wil:0}; 
    renderStore(); 
}

function renderStore() {
    const p = party[storePlayerIdx];
    let c = `<div style="margin: 15px 0;">
        <img src="${p.i}" style="width: 70px; height: 70px; border: 3px solid var(--gold); background: #000;">
    </div>
    <h3 class="medieval">${p.pName}'s Restoration</h3>
    <p>Soul Points: <b style="color: var(--gold-bright);">${storePoints}</b></p>
    <div style="background: rgba(0,0,0,0.1); padding: 10px; margin: 15px 0;">`;
    
    ['pow','spd','brn','cha','wil'].forEach(s => {
        const current = p.cur[s];
        const adding = tempStats[s];
        c += `<div style="display: flex; justify-content: space-between; align-items: center; margin: 8px 0; padding: 5px; background: rgba(197,160,89,0.1);">
            <span><b>${s.toUpperCase()}</b>: ${current} ${adding > 0 ? `<span style="color:#2ecc71;">+${adding}</span>` : ''}</span>
            <div>
                <button onclick="modSt('${s}',-1)" ${tempStats[s]<=0?'disabled':''} style="padding:5px 10px;">âˆ’</button>
                <button onclick="modSt('${s}',1)" ${storePoints<=0?'disabled':''} style="padding:5px 10px;">+</button>
            </div>
        </div>`;
    });
    
    c += `</div>`;
    c += storePoints > 0 
        ? `<p style="color:#ff9800; font-size:12px;">Spend all ${storePoints} points to continue</p>
           <button class="btn btn-skip" disabled>ðŸ”’ Spend All Points First</button>`
        : `<button class="btn btn-main" onclick="finishStore()">âœ“ Continue</button>`;
    
    showModal("ðŸ§ª The Alchemist's Den", "", c);
}

function modSt(s,v) { 
    if(v>0 && storePoints>0) { tempStats[s]++; storePoints--; } 
    if(v<0 && tempStats[s]>0) { tempStats[s]--; storePoints++; } 
    renderStore();
}

function finishStore() {
    for(let s in tempStats) party[storePlayerIdx].cur[s] += tempStats[s];
    storePlayerIdx++;
    
    if(storePlayerIdx < party.length) {
        openStore();
    } else { 
        // Apply the pending state that was saved before shop
        readerIdx = pendingReaderIdx;
        firstChallengerIdx = pendingFirstChallengerIdx;
        activeIdx = firstChallengerIdx;
        round = pendingRound;
        stageInRound = pendingStageInRound;
        
        // Check if game should end (deck exhausted)
        const totalStagesCompleted = (round * party.length) + stageInRound;
        if (totalStagesCompleted > totalRounds) {
            closeModal();
            endGame();
            return;
        }
        
        console.log(`ðŸ“œ After Shop - Round ${round + 1}, Stage ${stageInRound}: Reader: ${party[readerIdx].pName}`);
        resetUI();
    }
}

// ============================================================
// UI UPDATE
// ============================================================

function updatePartyUI() {
    document.getElementById('party-list').innerHTML = party.map((p, i) => {
        let isReader = (i === readerIdx);
        let isActive = (i === activeIdx);
        
        let statsDisplay = `<div class="stat-grid">${['pow','spd','brn','cha','wil'].map(s => `
            <div class="stat-box">
                <div class="stat-val">${p.cur[s]}</div>
                <span class="stat-lbl">${s}</span>
            </div>`).join('')}
        </div>`;
        
        return `
        ${isReader ? '<div class="reader-banner">ðŸ“œ READER - Opens & Sets Difficulty</div>' : ''}
        ${isActive && !isReader ? '<div class="turn-banner">âš”ï¸ YOUR TURN TO ATTEMPT âš”ï¸</div>' : ''}
        <div class="hero-sheet ${isActive ? 'active-now' : ''} ${isReader ? 'is-reader' : ''}">
            <div class="meditate-count">ðŸ§˜ ${p.skips} left</div>
            <div class="wax-seal"><span class="score-display">${p.score}</span></div>
            <div style="font-size:13px; font-weight:bold; letter-spacing:1px; color:#5a4634; margin-top: 2px;">${p.pName.toUpperCase()}</div>
            
            <div class="medieval" style="display: flex; align-items: center; gap: 15px; font-size:20px; margin: 10px 0;">
                <img src="${p.i}" alt="${p.n}" style="width: 60px; height: 60px; border: 2px solid #8e7b55; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); background: #000;">
                <span>${p.n}</span>
            </div>

            ${statsDisplay}
            
            <div style="background: rgba(197,160,89,0.1); border-left: 3px solid var(--gold); padding: 6px 8px; margin-top: 12px; font-size: 10px;">
                <div style="color: var(--gold-bright); font-weight: bold;">âš¡ ${p.passive}</div>
                <div style="color: var(--blood); line-height: 1.2;">${p.passiveDesc}</div>
            </div>
        </div>
    `;
    }).join('');
}

// ============================================================
// END GAME
// ============================================================

function endGame() {
    const maxScore = Math.max(...party.map(p => p.score));
    const winners = party.filter(p => p.score === maxScore);
    
    winners.forEach(w => recordWin(w));
    
    let content = '';
    if (winners.length === 1) {
        const winner = winners[0];
        content = `
            <div style="margin: 20px 0;">
                <img src="${winner.i}" style="width: 100px; border: 3px solid var(--gold);">
                <p style="font-size: 20px; color: var(--gold); margin-top: 10px;">${winner.pName} the ${winner.n}</p>
                <p style="font-size: 24px; color: var(--gold-bright);">${winner.score} Glory!</p>
            </div>
            ${getLeaderboardHTML()}
            <button class="btn btn-main" style="margin-top: 25px;" onclick="location.reload()">Play Again</button>
        `;
        showModal("ðŸ† VICTORY!", "A Legend is Born!", content);
    } else {
        const winnerNames = winners.map(w => w.pName).join(' & ');
        content = `
            <p style="font-size: 28px; color: var(--gold);">ðŸ¤ TIE! ðŸ¤</p>
            <p>${maxScore} Glory each!</p>
            <div style="margin: 20px 0;">
                ${winners.map(w => `<img src="${w.i}" style="width: 70px; border: 3px solid var(--gold); margin: 5px;">`).join('')}
            </div>
            <p style="color: var(--gold);">${winnerNames}</p>
            ${getLeaderboardHTML()}
            <button class="btn btn-main" style="margin-top: 25px;" onclick="location.reload()">Play Again</button>
        `;
        showModal("ðŸ† SHARED VICTORY!", "Legends Rise Together!", content);
    }
}

function recordWin(hero) {
    let winHistory = JSON.parse(localStorage.getItem('pavel_wins') || '{}');
    winHistory[hero.n] = (winHistory[hero.n] || 0) + 1;
    localStorage.setItem('pavel_wins', JSON.stringify(winHistory));
}

function getLeaderboardHTML() {
    let winHistory = JSON.parse(localStorage.getItem('pavel_wins') || '{}');
    const sorted = Object.entries(winHistory).sort(([,a], [,b]) => b - a);
    
    if (sorted.length === 0) return "";
    
    return `
        <div style="text-align: left; margin-top: 15px; background: rgba(0,0,0,0.1); padding: 10px; border: 1px solid #8e7b55;">
            <p style="font-weight: bold; color: var(--gold-bright); font-size: 14px; margin-bottom: 8px;">ðŸ“œ HALL OF VICTORS</p>
            ${sorted.map(([hero, wins]) => `
                <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px;">
                    <span>${hero}</span>
                    <span style="color: var(--gold);">${wins} Win${wins > 1 ? 's' : ''}</span>
                </div>
            `).join('')}
        </div>
    `;
}

function resetHallOfFame() {
    if(confirm("Erase all history?")) {
        localStorage.removeItem('pavel_wins');
        alert("History erased.");
        location.reload();
    }
}

// ============================================================
// FULLSCREEN
// ============================================================

function enterFullscreen() {
    const elem = document.documentElement;
    if (elem.requestFullscreen) elem.requestFullscreen();
    else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
    else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
}

function exitFullscreen() {
    if (document.exitFullscreen) document.exitFullscreen();
    else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
    else if (document.msExitFullscreen) document.msExitFullscreen();
}

function startGameFullscreen() {
    document.getElementById('fullscreen-splash').style.display = 'none';
    document.getElementById('exit-fullscreen').style.display = 'block';
    enterFullscreen();
}

document.addEventListener('fullscreenchange', () => {
    const isFullscreen = !!document.fullscreenElement;
    document.getElementById('exit-fullscreen').style.display = isFullscreen ? 'block' : 'none';
});
</script>
</body>
</html>
